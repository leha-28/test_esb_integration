<?xml version="1.0" encoding="UTF-8"?>
<con:pipelineEntry xmlns:con="http://www.bea.com/wli/sb/pipeline/config" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config">
    <con:coreEntry>
        <con:binding type="Native REST" xsi:type="con:NativeRestBindingType">
            <con:wadl ref="sampleSB/Resources/RestService"/>
        </con:binding>
        <con:xqConfiguration>
            <con:snippetVersion>1.0</con:snippetVersion>
        </con:xqConfiguration>
    </con:coreEntry>
    <con:router errorHandler="error-N53ede7ac.N193d93f5.0.18ba383078a.N8000">
        <con:pipeline type="request" name="request-N53edf6a2.N3b0158.0.18b36bcce0e.N7ff1">
            <con:stage id="_StageId-N53edf6a2.N3b0158.0.18b36bcce0e.N7fef" name="execstartTime">
                <con:context/>
                <con:actions>
                    <con1:assign varName="execStartTime">
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7feb</con2:id>
                        <con1:expr>
                            <con2:xqueryText>((current-dateTime() - xs:dateTime("1970-01-01T00:00:00-00:00")) div xs:dayTimeDuration('PT0.001S'))</con2:xqueryText>
                        </con1:expr>
                    </con1:assign>
                </con:actions>
            </con:stage>
            <con:stage id="_StageId-N53edf6a2.N3b0158.0.18b36bcce0e.N7fea" name="orchestration_check">
                <con:context>
                    <con2:userNsDecl prefix="h" namespace="http://telefonica.com/globalIntegration/header"/>
                </con:context>
                <con:actions>
                    <con1:ifThenElse>
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7fe3</con2:id>
                        <con1:case id="_BranchId-N53edf6a2.N3b0158.0.18b36bcce0e.N7fe2">
                            <con1:condition>
                                <con2:xqueryText>exists($header/h:HeaderIn/h:execId)</con2:xqueryText>
                            </con1:condition>
                            <con1:actions>
                                <con1:assign varName="IsOrchestratedCall">
                                    <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7fdf</con2:id>
                                    <con1:expr>
                                        <con2:xqueryText>'true'</con2:xqueryText>
                                    </con1:expr>
                                </con1:assign>
                            </con1:actions>
                        </con1:case>
                        <con1:default/>
                    </con1:ifThenElse>
                </con:actions>
            </con:stage>
            <con:stage id="_StageId-N53edf6a2.N3b0158.0.18b36bcce0e.N7fde" name="header construction">
                <con:context/>
                <con:actions>
                    <con1:replace varName="header" contents-only="false">
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7fdb</con2:id>
                        <con1:location>
                            <con2:xpathText>.</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xqueryTransform>
                                <con2:resource ref="CommonResources/transformations/ConstructRequestSOAPHeaderFromUserHeader"/>
                                <con2:param name="inbound">
                                    <con2:path>$inbound</con2:path>
                                </con2:param>
                                <con2:param name="header">
                                    <con2:path>$header</con2:path>
                                </con2:param>
                                <con2:param name="messageID">
                                    <con2:path>$messageID</con2:path>
                                </con2:param>
                            </con2:xqueryTransform>
                        </con1:expr>
                    </con1:replace>
                </con:actions>
            </con:stage>
            <con:stage id="_StageId-N53edf6a2.N3b0158.0.18b36bcce0e.N7fda" name="Capture_Inbound">
                <con:context/>
                <con:actions>
                    <con1:assign varName="mainInbound">
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7fd7</con2:id>
                        <con1:expr>
                            <con2:xqueryText><![CDATA[<endpoint name="ProxyService$sampleSB$proxyservices$sampleSB"
	xmlns:con="http://www.bea.com/wli/sb/context">
	<service>
		<operation>{data($inbound/ctx:service/ctx:operation)}</operation>
	</service>
	<transport>
		<uri>/api/notificationManagement/v1</uri>
		<mode>request-response</mode>
		<qualityOfService>best-effort</qualityOfService>
		<request xsi:type="http:HttpRequestMetaData"
			xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
			xmlns:http="http://www.bea.com/wli/sb/transports/http">
			<headers xsi:type="http:HttpRequestHeaders"
				xmlns="http://www.bea.com/wli/sb/transports">
				<Content-Type
					xmlns="http://www.bea.com/wli/sb/transports/http">application/json
				</Content-Type>
			</headers>
			<query-parameters
				xmlns="http://www.bea.com/wli/sb/transports/http"/>
			</request>
			<response xsi:type="http:HttpResponseMetaData"
				xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
				xmlns:http="http://www.bea.com/wli/sb/transports/http">
				<headers xsi:type="http:HttpResponseHeaders"
					xmlns="http://www.bea.com/wli/sb/transports"/>
					<response-code
						xmlns="http://www.bea.com/wli/sb/transports">0
					</response-code>
				</response>
			</transport>
			<security>
				<transportClient>
					<username>&lt;anonymous></username>
				</transportClient>
			</security>
		</endpoint>]]></con2:xqueryText>
                        </con1:expr>
                    </con1:assign>
                </con:actions>
            </con:stage>
            <con:stage id="_StageId-N53edf6a2.N3b0158.0.18b36bcce0e.N7fd6" name="Log_Entry_Header_Body">
                <con:context>
                    <con2:userNsDecl prefix="cor" namespace="http://soa.o2.co.uk/coredata_1"/>
                    <con2:userNsDecl prefix="header" namespace="http://telefonica.com/globalIntegration/header"/>
                </con:context>
                <con:actions>
                    <con3:route>
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f8c</con2:id>
                        <con3:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con3:operation>execute</con3:operation>
                        <con3:outboundTransform>
                            <con1:routing-options>
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f89</con2:id>
                                <con1:mode>request</con1:mode>
                                <con1:qualityOfService>best-effort</con1:qualityOfService>
                            </con1:routing-options>
                            <con1:replace varName="body" contents-only="true">
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f86</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                        <con2:param name="messageID">
                                            <con2:path>$messageID</con2:path>
                                        </con2:param>
                                        <con2:param name="eventType">
                                            <con2:path>if($IsOrchestratedCall = 'true') then
"ENTRY:HEADER"
else
"BEGIN:HEADER"</con2:path>
                                        </con2:param>
                                        <con2:param name="serviceName">
                                            <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                        </con2:param>
                                        <con2:param name="inputSummary">
                                            <con2:path>"Sample_HEADER_Request"</con2:path>
                                        </con2:param>
                                        <con2:param name="inputLevel">
                                            <con2:path>1</con2:path>
                                        </con2:param>
                                        <con2:param name="execID">
                                            <con2:path>$header/header:HeaderIn/header:execId/text()</con2:path>
                                        </con2:param>
                                        <con2:param name="eventCode">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="outboundServiceName">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="processName">
                                            <con2:path>fn:concat(fn:tokenize($inbound/@name,"\$")[last()],".",$header/header:HeaderIn/header:operation/text())</con2:path>
                                        </con2:param>
                                        <con2:param name="eventStatus">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="layerName">
                                            <con2:path>"ESB"</con2:path>
                                        </con2:param>
                                        <con2:param name="flowID">
                                            <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                        </con2:param>
                                        <con2:param name="inputElement">
                                            <con2:path>$header/header:HeaderIn</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:replace>
                        </con3:outboundTransform>
                    </con3:route>
                    <con3:route>
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f83</con2:id>
                        <con3:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con3:operation>execute</con3:operation>
                        <con3:outboundTransform>
                            <con1:routing-options>
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f80</con2:id>
                                <con1:mode>request</con1:mode>
                                <con1:qualityOfService>best-effort</con1:qualityOfService>
                            </con1:routing-options>
                            <con1:replace varName="body" contents-only="true">
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f7d</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                        <con2:param name="messageID">
                                            <con2:path>$messageID</con2:path>
                                        </con2:param>
                                        <con2:param name="eventType">
                                            <con2:path>if($IsOrchestratedCall = 'true') then
"ENTRY:BODY"
else
"BEGIN:BODY"</con2:path>
                                        </con2:param>
                                        <con2:param name="serviceName">
                                            <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                        </con2:param>
                                        <con2:param name="inputSummary">
                                            <con2:path>"sample_BODY_Request"</con2:path>
                                        </con2:param>
                                        <con2:param name="inputLevel">
                                            <con2:path>1</con2:path>
                                        </con2:param>
                                        <con2:param name="execID">
                                            <con2:path>$header/header:HeaderIn/header:execId/text()</con2:path>
                                        </con2:param>
                                        <con2:param name="eventCode">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="outboundServiceName">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="processName">
                                            <con2:path>fn:concat(fn:tokenize($inbound/@name,"\$")[last()],".",$header/header:HeaderIn/header:operation/text())</con2:path>
                                        </con2:param>
                                        <con2:param name="eventStatus">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="layerName">
                                            <con2:path>"ESB"</con2:path>
                                        </con2:param>
                                        <con2:param name="flowID">
                                            <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                        </con2:param>
                                        <con2:param name="inputElement">
                                            <con2:path>if($IsOrchestratedCall = 'true' and (not(exists($incomingHeader/cor:debugFlag)) or 	
data($incomingHeader/cor:debugFlag)="false" ))then
&lt;Body/>
else
$body</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:replace>
                        </con3:outboundTransform>
                    </con3:route>
                </con:actions>
            </con:stage>
            <con:stage id="_StageId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f7c" name="Reading Config Data">
                <con:context/>
                <con:actions>
                    <con1:javaCallout varName="config">
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f79</con2:id>
                        <con1:archive ref="Utility/configdatamanagement/configdatamanagement"/>
                        <con1:className>uk.co.o2.soa.sf.xmldata.parsing.impl.ConfigFileManager</con1:className>
                        <con1:method>public static java.lang.String retreiveServiceData(org.apache.xmlbeans.XmlObject)</con1:method>
                        <con1:expr>
                            <con2:xqueryText>$mainInbound</con2:xqueryText>
                        </con1:expr>
                        <con1:return-param-as-ref>false</con1:return-param-as-ref>
                    </con1:javaCallout>
                    <con1:assign varName="configXML">
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f76</con2:id>
                        <con1:expr>
                            <con2:xqueryText>fn-bea:inlinedXML($config)/service-config-data/SendPortNotification</con2:xqueryText>
                        </con1:expr>
                    </con1:assign>
                </con:actions>
            </con:stage>
            <con:stage id="_StageId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f75" name="Capture header">
                <con:context/>
                <con:actions>
                    <con1:assign varName="incomingHeader">
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f72</con2:id>
                        <con1:expr>
                            <con2:xqueryText>$header</con2:xqueryText>
                        </con1:expr>
                    </con1:assign>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="response" name="response-N53edf6a2.N3b0158.0.18b36bcce0e.N7ff0">
            <con:stage id="_StageId-N53edf6a2.N3b0158.0.18b36bcce0e.N7fee" name="Total_Backend_exe">
                <con:context/>
                <con:actions>
                    <con1:assign varName="tExecBackend">
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f6f</con2:id>
                        <con1:expr>
                            <con2:xqueryText>xs:integer((current-dateTime() - xs:dateTime("1970-01-01T00:00:00-00:00")) div xs:dayTimeDuration('PT0.001S')) - xs:integer($initExecBackend)</con2:xqueryText>
                        </con1:expr>
                    </con1:assign>
                </con:actions>
            </con:stage>
            <con:stage id="_StageId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f6e" name="Log_Exit_Header_BODY">
                <con:context>
                    <con2:userNsDecl prefix="cor" namespace="http://soa.o2.co.uk/coredata_1"/>
                    <con2:userNsDecl prefix="header" namespace="http://telefonica.com/globalIntegration/header"/>
                </con:context>
                <con:actions>
                    <con1:replace varName="header">
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f6b</con2:id>
                        <con1:location>
                            <con2:xpathText>.</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xqueryTransform>
                                <con2:resource ref="CommonResources/transformations/ConstructResponseSOAPHeaderForCookie"/>
                                <con2:param name="inbound_header">
                                    <con2:path>false()</con2:path>
                                </con2:param>
                                <con2:param name="onError">
                                    <con2:path>false()</con2:path>
                                </con2:param>
                                <con2:param name="jsessionValue">
                                    <con2:path>$jsessionValue</con2:path>
                                </con2:param>
                                <con2:param name="inbound">
                                    <con2:path>$inbound</con2:path>
                                </con2:param>
                                <con2:param name="header">
                                    <con2:path>$incomingHeader</con2:path>
                                </con2:param>
                                <con2:param name="aviValue">
                                    <con2:path>$aviValue</con2:path>
                                </con2:param>
                            </con2:xqueryTransform>
                        </con1:expr>
                    </con1:replace>
                    <con1:assign varName="outboundContext">
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f68</con2:id>
                        <con1:expr>
                            <con2:xqueryText>$outbound</con2:xqueryText>
                        </con1:expr>
                    </con1:assign>
                    <con1:replace varName="inbound">
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f65</con2:id>
                        <con1:location>
                            <con2:xpathText>./ctx:transport/ctx:response</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xqueryTransform>
                                <con2:resource ref="CommonResources/transformations/ConstructResponseUserHeader"/>
                                <con2:param name="incomingHeader">
                                    <con2:path>$incomingHeader</con2:path>
                                </con2:param>
                                <con2:param name="header">
                                    <con2:path>$header</con2:path>
                                </con2:param>
                            </con2:xqueryTransform>
                        </con1:expr>
                    </con1:replace>
                    <con3:route>
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f62</con2:id>
                        <con3:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con3:operation>execute</con3:operation>
                        <con3:outboundTransform>
                            <con1:routing-options>
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f5f</con2:id>
                                <con1:mode>request</con1:mode>
                                <con1:qualityOfService>best-effort</con1:qualityOfService>
                            </con1:routing-options>
                            <con1:replace varName="body" contents-only="true">
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f5c</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                        <con2:param name="messageID">
                                            <con2:path>$messageID</con2:path>
                                        </con2:param>
                                        <con2:param name="eventType">
                                            <con2:path>if($IsOrchestratedCall = 'true') then
"EXIT:HEADER"
else
"END:HEADER"</con2:path>
                                        </con2:param>
                                        <con2:param name="serviceName">
                                            <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                        </con2:param>
                                        <con2:param name="inputSummary">
                                            <con2:path>"Sample_HEADER_Response"</con2:path>
                                        </con2:param>
                                        <con2:param name="inputLevel">
                                            <con2:path>1</con2:path>
                                        </con2:param>
                                        <con2:param name="execID">
                                            <con2:path>$header/header:HeaderOut/header:execId/text()</con2:path>
                                        </con2:param>
                                        <con2:param name="eventCode">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="outboundServiceName">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="processName">
                                            <con2:path>fn:concat(fn:tokenize($inbound/@name, "\$")[last()],".",$incomingHeader/header:HeaderIn/header:operation/text())</con2:path>
                                        </con2:param>
                                        <con2:param name="eventStatus">
                                            <con2:path>"SUCCESS"</con2:path>
                                        </con2:param>
                                        <con2:param name="layerName">
                                            <con2:path>"ESB"</con2:path>
                                        </con2:param>
                                        <con2:param name="flowID">
                                            <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                        </con2:param>
                                        <con2:param name="inputElement">
                                            <con2:path>$header/header:HeaderOut</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:replace>
                        </con3:outboundTransform>
                    </con3:route>
                    <con3:route>
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f59</con2:id>
                        <con3:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con3:operation>execute</con3:operation>
                        <con3:outboundTransform>
                            <con1:routing-options>
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f56</con2:id>
                                <con1:mode>request</con1:mode>
                                <con1:qualityOfService>best-effort</con1:qualityOfService>
                            </con1:routing-options>
                            <con1:replace varName="body" contents-only="true">
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f53</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                        <con2:param name="messageID">
                                            <con2:path>$messageID</con2:path>
                                        </con2:param>
                                        <con2:param name="eventType">
                                            <con2:path>if($IsOrchestratedCall = 'true') then
"EXIT:BODY"
else
"END:BODY"</con2:path>
                                        </con2:param>
                                        <con2:param name="serviceName">
                                            <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                        </con2:param>
                                        <con2:param name="inputSummary">
                                            <con2:path>"sample_BODY_Response"</con2:path>
                                        </con2:param>
                                        <con2:param name="inputLevel">
                                            <con2:path>1</con2:path>
                                        </con2:param>
                                        <con2:param name="execID">
                                            <con2:path>$header/header:HeaderOut/header:execId/text()</con2:path>
                                        </con2:param>
                                        <con2:param name="eventCode">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="outboundServiceName">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="processName">
                                            <con2:path>fn:concat(fn:tokenize($inbound/@name, "\$")[last()],".",$incomingHeader/header:HeaderIn/header:operation/text())</con2:path>
                                        </con2:param>
                                        <con2:param name="eventStatus">
                                            <con2:path>"SUCCESS"</con2:path>
                                        </con2:param>
                                        <con2:param name="layerName">
                                            <con2:path>"ESB"</con2:path>
                                        </con2:param>
                                        <con2:param name="flowID">
                                            <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                        </con2:param>
                                        <con2:param name="inputElement">
                                            <con2:path>if($isOrchestratedCall = 'true' and (not(exists($incomingHeader/cor:debugFlag)) or data($incomingHeader/cor:debugFlag)="false" ))then
&lt;Body/>
else
$body</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:replace>
                        </con3:outboundTransform>
                    </con3:route>
                </con:actions>
            </con:stage>
            <con:stage id="_StageId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f52" name="Final_Execution_log">
                <con:context/>
                <con:actions>
                    <con3:route>
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f4f</con2:id>
                        <con3:service ref="ArchitectureServices/ExecutionLogService/ProxyServices/ExecutionLogServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con3:operation>execute</con3:operation>
                        <con3:outboundTransform>
                            <con1:routing-options>
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f4c</con2:id>
                                <con1:mode>request</con1:mode>
                                <con1:qualityOfService>best-effort</con1:qualityOfService>
                            </con1:routing-options>
                            <con1:replace varName="body" contents-only="true">
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f49</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="CommonResources/transformations/ExecutionLogInfo"/>
                                        <con2:param name="tExecBackend">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="incomingHeader">
                                            <con2:path>$incomingHeader</con2:path>
                                        </con2:param>
                                        <con2:param name="resultCode">
                                            <con2:path>"OK"</con2:path>
                                        </con2:param>
                                        <con2:param name="messageID">
                                            <con2:path>$messageID</con2:path>
                                        </con2:param>
                                        <con2:param name="error">
                                            <con2:path>&lt;error/></con2:path>
                                        </con2:param>
                                        <con2:param name="layer">
                                            <con2:path>"ESB"</con2:path>
                                        </con2:param>
                                        <con2:param name="errorText">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="serviceBackend">
                                            <con2:path>fn:tokenize($outboundContext/@name, "\$")[last()]</con2:path>
                                        </con2:param>
                                        <con2:param name="operationBackend">
                                            <con2:path>$outboundContext/ctx:service/ctx:operation/text()</con2:path>
                                        </con2:param>
                                        <con2:param name="service">
                                            <con2:path>"SendPortNotification"</con2:path>
                                        </con2:param>
                                        <con2:param name="outboundContext">
                                            <con2:path>&lt;outboundContext/></con2:path>
                                        </con2:param>
                                        <con2:param name="header">
                                            <con2:path>$header</con2:path>
                                        </con2:param>
                                        <con2:param name="inboundContext">
                                            <con2:path>$inbound</con2:path>
                                        </con2:param>
                                        <con2:param name="execStartTime">
                                            <con2:path>$execStartTime</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:replace>
                        </con3:outboundTransform>
                    </con3:route>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="request" name="request-N53edf6a2.N3b0158.0.18b36bcce0e.N7f48">
            <con:stage id="_StageId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f46" name="request">
                <con:context/>
                <con:actions>
                    <con1:javaScript>
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f11</con2:id>
                        <con1:script>var $request = process.body
process.msisdnValue= $request.msisdn</con1:script>
                        <con1:timeout>-1</con1:timeout>
                    </con1:javaScript>
                    <con1:ifThenElse>
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f0a</con2:id>
                        <con1:case id="_BranchId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f09">
                            <con1:condition>
                                <con2:xqueryText>string-length(data($msisdnValue))=12 and 
starts-with(data($msisdnValue),'44')</con2:xqueryText>
                            </con1:condition>
                            <con1:actions/>
                        </con1:case>
                        <con1:default>
                            <con1:Error>
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f06</con2:id>
                                <con1:errCode>OSB-382505</con1:errCode>
                                <con1:message>Request validation failed.</con1:message>
                            </con1:Error>
                        </con1:default>
                    </con1:ifThenElse>
                    <con1:javaScript>
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f03</con2:id>
                        <con1:script>var $request = process.body
process.commsChannelValue= $request.commsChannel</con1:script>
                        <con1:timeout>-1</con1:timeout>
                    </con1:javaScript>
                    <con1:ifThenElse>
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7efc</con2:id>
                        <con1:case id="_BranchId-N53edf6a2.N3b0158.0.18b36bcce0e.N7efb">
                            <con1:condition>
                                <con2:xqueryText>data($commsChannelValue) =string(data($configXML/letter)) or
data($commsChannelValue) =string(data($configXML/email)) or
data($commsChannelValue) =string(data($configXML/standardletter)) or
data($commsChannelValue) =string(data($configXML/sms))</con2:xqueryText>
                            </con1:condition>
                            <con1:actions/>
                        </con1:case>
                        <con1:default>
                            <con1:Error>
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7ef8</con2:id>
                                <con1:errCode>OSB-382505</con1:errCode>
                                <con1:message>Request validation failed.</con1:message>
                            </con1:Error>
                        </con1:default>
                    </con1:ifThenElse>
                    <con1:javaScript>
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7ef5</con2:id>
                        <con1:script>var $request = process.body
process.notificationTypeId= $request.notificationTypeId</con1:script>
                    </con1:javaScript>
                    <con1:ifThenElse>
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7e49</con2:id>
                        <con1:case id="_BranchId-N53edf6a2.N3b0158.0.18b36bcce0e.N7e48">
                            <con1:condition>
                                <con2:xqueryText>exists(data($notificationTypeId))</con2:xqueryText>
                            </con1:condition>
                            <con1:actions>
                                <con1:ifThenElse>
                                    <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7e41</con2:id>
                                    <con1:case id="_BranchId-N53edf6a2.N3b0158.0.18b36bcce0e.N7e40">
                                        <con1:condition>
                                            <con2:xqueryText>data($notificationTypeId) =string(data($configXML/notificationTypeId1)) or
data($notificationTypeId) =string(data($configXML/notificationTypeId2))</con2:xqueryText>
                                        </con1:condition>
                                        <con1:actions/>
                                    </con1:case>
                                    <con1:default>
                                        <con1:Error>
                                            <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7e3d</con2:id>
                                            <con1:errCode>OSB-382505</con1:errCode>
                                            <con1:message>Request validation failed.</con1:message>
                                        </con1:Error>
                                    </con1:default>
                                </con1:ifThenElse>
                            </con1:actions>
                        </con1:case>
                        <con1:default/>
                    </con1:ifThenElse>
                </con:actions>
            </con:stage>
            <con:stage id="_StageId-N53edf6a2.N3b0158.0.18b36bcce0e.N7e3c" name="Call to Get Id of the Last Notification Record By PUID">
                <con:context>
                    <con2:userNsDecl prefix="cor" namespace="http://soa.o2.co.uk/coredata_1"/>
                    <con2:userNsDecl prefix="header" namespace="http://telefonica.com/globalIntegration/header"/>
                </con:context>
                <con:actions>
                    <con1:wsCallout>
                        <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7e39</con2:id>
                        <con1:service ref="DynamicNcRouter/proxyservices/DynamicNcRouter" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con1:request>
                            <con1:body wrapped="true">body</con1:body>
                            <con1:header>incomingHeader</con1:header>
                        </con1:request>
                        <con1:response>
                            <con1:body wrapped="true">body</con1:body>
                        </con1:response>
                        <con1:requestTransform>
                            <con1:assign varName="msisdnn">
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7e36</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>replace(($msisdnValue), '^44', '0')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:assign varName="relativeURL">
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7e33</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>(data($configXML/URL))</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:assign varName="queryparameters">
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7e30</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>&lt;http:query-parameters xmlns:http="http://www.bea.com/wli/sb/transports/http">
&lt;http:parameter name="msisdn" value="{data($msisdnn)}"/>
&lt;http:parameter name="notificationTypeId" value="{if(exists(data($notificationTypeId))) then
data($notificationTypeId)
else 
data($configXML/notificationTypeId2)
}"/>
&lt;/http:query-parameters></con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:replace varName="body" contents-only="true">
                                <con2:id>_ActionId-N53edf6a2.N3b0158.0.18b36bcce0e.N7e2d</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="DynamicNcRouter/transformations/RequestConstructionToDynamicRouting"/>
                                        <con2:param name="http-method">
                                            <con2:path>$configXML/GET_method</con2:path>
                                        </con2:param>
                                        <con2:param name="addtionalheaders">
                                            <con2:path>&lt;a/></con2:path>
                                        </con2:param>
                                        <con2:param name="payload">
                                            <con2:path>&lt;a/></con2:path>
                                        </con2:param>
                                        <con2:param name="queryparameters">
                                            <con2:path>if(fn:exists(data($queryparameters)))then
$queryparameters
else &lt;a/></con2:path>
                                        </con2:param>
                                        <con2:param name="relativePath">
                                            <con2:path>&lt;a>{$relativeURL}&lt;/a></con2:path>
                                        </con2:param>
                                        <con2:param name="operation">
                                            <con2:path>$configXML/Operation1</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:replace>
                            <con1:assign varName="NC_operationName">
                                <con2:id>_ActionId-N53edf6a2.1fc34ef9.0.18b6fc95416.N7ffe</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>data($body/DynamicRoutingRequest/operation)</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:assign varName="outboundContext">
                                <con2:id>_ActionId-N53edf6a2.1fc34ef9.0.18b6fc95416.N7ffb</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>$outbound</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con3:route>
                                <con2:id>_ActionId-N53edf6a2.1fc34ef9.0.18b6fc95416.N7ff8</con2:id>
                                <con3:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                <con3:operation>execute</con3:operation>
                                <con3:outboundTransform>
                                    <con1:routing-options>
                                        <con2:id>_ActionId-N53edf6a2.1fc34ef9.0.18b6fc95416.N7ff5</con2:id>
                                        <con1:mode>request</con1:mode>
                                        <con1:qualityOfService>best-effort</con1:qualityOfService>
                                    </con1:routing-options>
                                    <con1:replace varName="body" contents-only="true">
                                        <con2:id>_ActionId-N53edf6a2.1fc34ef9.0.18b6fc95416.N7ff2</con2:id>
                                        <con1:location>
                                            <con2:xpathText>.</con2:xpathText>
                                        </con1:location>
                                        <con1:expr>
                                            <con2:xqueryTransform>
                                                <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                                <con2:param name="messageID">
                                                    <con2:path>$messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="eventType">
                                                    <con2:path>"OUTBOUND:HEADER"</con2:path>
                                                </con2:param>
                                                <con2:param name="serviceName">
                                                    <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                                </con2:param>
                                                <con2:param name="inputSummary">
                                                    <con2:path>"SampleSB_Headers_Request"</con2:path>
                                                </con2:param>
                                                <con2:param name="inputLevel">
                                                    <con2:path>1</con2:path>
                                                </con2:param>
                                                <con2:param name="execID">
                                                    <con2:path>$incomingHeader/header:HeaderIn/header:execId/text()</con2:path>
                                                </con2:param>
                                                <con2:param name="eventCode">
                                                    <con2:path>""</con2:path>
                                                </con2:param>
                                                <con2:param name="outboundServiceName">
                                                    <con2:path>fn:concat(fn:tokenize($outboundContext/@name, "\$")[last()],".",data($NC_operationName))</con2:path>
                                                </con2:param>
                                                <con2:param name="processName">
                                                    <con2:path>fn:concat(fn:tokenize($inbound/@name, "\$")[last()],".",$incomingHeader/header:HeaderIn/header:operation/text())</con2:path>
                                                </con2:param>
                                                <con2:param name="eventStatus">
                                                    <con2:path>""</con2:path>
                                                </con2:param>
                                                <con2:param name="layerName">
                                                    <con2:path>"ESB"</con2:path>
                                                </con2:param>
                                                <con2:param name="flowID">
                                                    <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="inputElement">
                                                    <con2:path>$header/header:HeaderIn</con2:path>
                                                </con2:param>
                                            </con2:xqueryTransform>
                                        </con1:expr>
                                    </con1:replace>
                                </con3:outboundTransform>
                            </con3:route>
                            <con3:route>
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7ffe</con2:id>
                                <con3:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                <con3:operation>execute</con3:operation>
                                <con3:outboundTransform>
                                    <con1:routing-options>
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7ffb</con2:id>
                                        <con1:mode>request</con1:mode>
                                        <con1:qualityOfService>best-effort</con1:qualityOfService>
                                    </con1:routing-options>
                                    <con1:replace varName="body" contents-only="true">
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7ff8</con2:id>
                                        <con1:location>
                                            <con2:xpathText>.</con2:xpathText>
                                        </con1:location>
                                        <con1:expr>
                                            <con2:xqueryTransform>
                                                <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                                <con2:param name="messageID">
                                                    <con2:path>$messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="eventType">
                                                    <con2:path>"OUTBOUND:BODY"</con2:path>
                                                </con2:param>
                                                <con2:param name="serviceName">
                                                    <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                                </con2:param>
                                                <con2:param name="inputSummary">
                                                    <con2:path>"SampleSB_Body_Request"</con2:path>
                                                </con2:param>
                                                <con2:param name="inputLevel">
                                                    <con2:path>1</con2:path>
                                                </con2:param>
                                                <con2:param name="execID">
                                                    <con2:path>$incomingHeader/header:HeaderIn/header:execId/text()</con2:path>
                                                </con2:param>
                                                <con2:param name="eventCode">
                                                    <con2:path>""</con2:path>
                                                </con2:param>
                                                <con2:param name="outboundServiceName">
                                                    <con2:path>fn:concat(fn:tokenize($outboundContext/@name, "\$")[last()],".",data($NC_operationName))</con2:path>
                                                </con2:param>
                                                <con2:param name="processName">
                                                    <con2:path>fn:concat(fn:tokenize($inbound/@name, "\$")[last()],".",$incomingHeader/header:HeaderIn/header:operation/text())</con2:path>
                                                </con2:param>
                                                <con2:param name="eventStatus">
                                                    <con2:path>""</con2:path>
                                                </con2:param>
                                                <con2:param name="layerName">
                                                    <con2:path>"ESB"</con2:path>
                                                </con2:param>
                                                <con2:param name="flowID">
                                                    <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="inputElement">
                                                    <con2:path>if(data($incomingHeader/cor:debugFlag)="true") then
&lt;Body>{$body/*}&lt;/Body>
else
&lt;Body/></con2:path>
                                                </con2:param>
                                            </con2:xqueryTransform>
                                        </con1:expr>
                                    </con1:replace>
                                </con3:outboundTransform>
                            </con3:route>
                            <con1:assign varName="initExecBackend">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7ff5</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>(current-dateTime() - xs:dateTime("1970-01-01T00:00:00-00:00")) div xs:dayTimeDuration('PT0.001S')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                        </con1:requestTransform>
                        <con1:responseTransform>
                            <con1:assign varName="jsessionValue">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7ff2</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>if(fn:exists(data($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="jsessionValue"]/@value)))then
fn-bea:inlinedXML($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="jsessionValue"]/@value)
else ""</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:assign varName="aviValue">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fef</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>if(fn:exists(data($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="aviValue"]/@value)))then
fn-bea:inlinedXML($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="aviValue"]/@value)
else ""</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:assign varName="backendJsession">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fec</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>if(fn:exists(data($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="backendJsession"]/@value)))then
fn-bea:inlinedXML($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="backendJsession"]/@value)
else ""</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:assign varName="backendAvi">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fe9</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>if(fn:exists(data($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="backendAvi"]/@value)))then
fn-bea:inlinedXML($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="backendAvi"]/@value)
else ""</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:ifThenElse>
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fe2</con2:id>
                                <con1:case id="_BranchId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fe1">
                                    <con1:condition>
                                        <con2:xqueryText>fn:exists($body/DynamicNcRouterFault/ctx:fault)
or
fn:exists($body/DynamicNcRouterFault/fault)
or 
((fn:contains(fn:normalize-space(fn-bea:serialize(data($body))),"errorCode")) and ((fn:contains(fn:normalize-space(fn-bea:serialize(data($body))),"userMessage")) or (fn:contains(fn:normalize-space(fn-bea:serialize(data($body))),"stacktrace"))))</con2:xqueryText>
                                    </con1:condition>
                                    <con1:actions>
                                        <con1:Error>
                                            <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fde</con2:id>
                                            <con1:errCode>NC_Router_error</con1:errCode>
                                        </con1:Error>
                                    </con1:actions>
                                </con1:case>
                                <con1:default/>
                            </con1:ifThenElse>
                            <con1:assign varName="tExecBackend">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fdb</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>xs:integer((current-dateTime() - xs:dateTime("1970-01-01T00:00:00-00:00")) div xs:dayTimeDuration('PT0.001S')) - xs:integer($initExecBackend)</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:replace varName="header">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fd8</con2:id>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="CommonResources/transformations/ConstructResponseSOAPHeaderForCookie"/>
                                        <con2:param name="inbound_header">
                                            <con2:path>true()</con2:path>
                                        </con2:param>
                                        <con2:param name="onError">
                                            <con2:path>false()</con2:path>
                                        </con2:param>
                                        <con2:param name="jsessionValue">
                                            <con2:path>$backendJsession</con2:path>
                                        </con2:param>
                                        <con2:param name="inbound">
                                            <con2:path>$inbound</con2:path>
                                        </con2:param>
                                        <con2:param name="header">
                                            <con2:path>$incomingHeader</con2:path>
                                        </con2:param>
                                        <con2:param name="aviValue">
                                            <con2:path>$backendAvi</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:replace>
                            <con1:assign varName="outboundContext">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fd5</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>if(fn:exists(data($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="outbound_value"]/@value)))then
fn-bea:inlinedXML($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="outbound_value"]/@value)
else ""</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:javaCallout varName="ResponseXML">
                                <con2:id>_ActionId-N53e1bf2f.N6dae6a6.0.18ba3136518.N7ffd</con2:id>
                                <con1:archive ref="Utility/convertXmlJson/Convert_XML_JSON"/>
                                <con1:className>uk.co.o2.esb.conversion.ConversionJSONtoXML</con1:className>
                                <con1:method>public static java.lang.String formatJson(java.lang.String)</con1:method>
                                <con1:expr>
                                    <con2:xqueryText>data($body)</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con1:javaCallout>
                            <con1:assign varName="formatted_ResponseXML">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fcf</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn-bea:inlinedXML(fn-bea:serialize($ResponseXML))</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:assign varName="enotificationRecordId">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fcb</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>data($formatted_ResponseXML/notificationRecordId)</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con3:route>
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fc8</con2:id>
                                <con3:service ref="ArchitectureServices/ExecutionLogService/ProxyServices/ExecutionLogServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                <con3:operation>execute</con3:operation>
                                <con3:outboundTransform>
                                    <con1:routing-options>
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fc5</con2:id>
                                        <con1:mode>request</con1:mode>
                                        <con1:qualityOfService>best-effort</con1:qualityOfService>
                                    </con1:routing-options>
                                    <con1:replace varName="body" contents-only="true">
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fc2</con2:id>
                                        <con1:location>
                                            <con2:xpathText>.</con2:xpathText>
                                        </con1:location>
                                        <con1:expr>
                                            <con2:xqueryTransform>
                                                <con2:resource ref="CommonResources/transformations/ExecutionLogInfo"/>
                                                <con2:param name="tExecBackend">
                                                    <con2:path>$tExecBackend</con2:path>
                                                </con2:param>
                                                <con2:param name="incomingHeader">
                                                    <con2:path>$incomingHeader</con2:path>
                                                </con2:param>
                                                <con2:param name="resultCode">
                                                    <con2:path>"OK"</con2:path>
                                                </con2:param>
                                                <con2:param name="messageID">
                                                    <con2:path>$messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="error">
                                                    <con2:path>&lt;error/></con2:path>
                                                </con2:param>
                                                <con2:param name="layer">
                                                    <con2:path>"ESB"</con2:path>
                                                </con2:param>
                                                <con2:param name="errorText">
                                                    <con2:path>""</con2:path>
                                                </con2:param>
                                                <con2:param name="serviceBackend">
                                                    <con2:path>fn:tokenize($outboundContext/@name, "\$")[last()]</con2:path>
                                                </con2:param>
                                                <con2:param name="operationBackend">
                                                    <con2:path>$outboundContext/ctx:service/ctx:operation/text()</con2:path>
                                                </con2:param>
                                                <con2:param name="service">
                                                    <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                                </con2:param>
                                                <con2:param name="outboundContext">
                                                    <con2:path>$outboundContext</con2:path>
                                                </con2:param>
                                                <con2:param name="header">
                                                    <con2:path>$header</con2:path>
                                                </con2:param>
                                                <con2:param name="inboundContext">
                                                    <con2:path>$inbound</con2:path>
                                                </con2:param>
                                                <con2:param name="execStartTime">
                                                    <con2:path>$execStartTime</con2:path>
                                                </con2:param>
                                            </con2:xqueryTransform>
                                        </con1:expr>
                                    </con1:replace>
                                </con3:outboundTransform>
                            </con3:route>
                            <con3:route>
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fbf</con2:id>
                                <con3:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                <con3:operation>execute</con3:operation>
                                <con3:outboundTransform>
                                    <con1:routing-options>
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fbc</con2:id>
                                        <con1:mode>request</con1:mode>
                                        <con1:qualityOfService>best-effort</con1:qualityOfService>
                                    </con1:routing-options>
                                    <con1:replace varName="body" contents-only="true">
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fb9</con2:id>
                                        <con1:location>
                                            <con2:xpathText>.</con2:xpathText>
                                        </con1:location>
                                        <con1:expr>
                                            <con2:xqueryTransform>
                                                <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                                <con2:param name="messageID">
                                                    <con2:path>$messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="eventType">
                                                    <con2:path>"INBOUND:HEADER"</con2:path>
                                                </con2:param>
                                                <con2:param name="serviceName">
                                                    <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                                </con2:param>
                                                <con2:param name="inputSummary">
                                                    <con2:path>"SampleSB_Headers_Response"</con2:path>
                                                </con2:param>
                                                <con2:param name="inputLevel">
                                                    <con2:path>1</con2:path>
                                                </con2:param>
                                                <con2:param name="execID">
                                                    <con2:path>$header/header:HeaderOut/header:execId/text()</con2:path>
                                                </con2:param>
                                                <con2:param name="eventCode">
                                                    <con2:path>""</con2:path>
                                                </con2:param>
                                                <con2:param name="outboundServiceName">
                                                    <con2:path>fn:concat(fn:tokenize($outboundContext/@name, "\$")[last()-2],".",data($NC_operationName))</con2:path>
                                                </con2:param>
                                                <con2:param name="processName">
                                                    <con2:path>fn:concat(fn:tokenize($inbound/@name, "\$")[last()],".",$incomingHeader/header:HeaderIn/header:operation/text())</con2:path>
                                                </con2:param>
                                                <con2:param name="eventStatus">
                                                    <con2:path>"SUCCESS"</con2:path>
                                                </con2:param>
                                                <con2:param name="layerName">
                                                    <con2:path>"ESB"</con2:path>
                                                </con2:param>
                                                <con2:param name="flowID">
                                                    <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="inputElement">
                                                    <con2:path>$header/header:HeaderOut</con2:path>
                                                </con2:param>
                                            </con2:xqueryTransform>
                                        </con1:expr>
                                    </con1:replace>
                                </con3:outboundTransform>
                            </con3:route>
                            <con3:route>
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fb6</con2:id>
                                <con3:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                <con3:operation>execute</con3:operation>
                                <con3:outboundTransform>
                                    <con1:routing-options>
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fb3</con2:id>
                                        <con1:mode>request</con1:mode>
                                        <con1:qualityOfService>best-effort</con1:qualityOfService>
                                    </con1:routing-options>
                                    <con1:replace varName="body" contents-only="true">
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fb0</con2:id>
                                        <con1:location>
                                            <con2:xpathText>.</con2:xpathText>
                                        </con1:location>
                                        <con1:expr>
                                            <con2:xqueryTransform>
                                                <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                                <con2:param name="messageID">
                                                    <con2:path>$messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="eventType">
                                                    <con2:path>"INBOUND:BODY"</con2:path>
                                                </con2:param>
                                                <con2:param name="serviceName">
                                                    <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                                </con2:param>
                                                <con2:param name="inputSummary">
                                                    <con2:path>"SampleSB_BODY_Response"</con2:path>
                                                </con2:param>
                                                <con2:param name="inputLevel">
                                                    <con2:path>1</con2:path>
                                                </con2:param>
                                                <con2:param name="execID">
                                                    <con2:path>$incomingHeader/header:HeaderIn/header:execId/text()</con2:path>
                                                </con2:param>
                                                <con2:param name="eventCode">
                                                    <con2:path>""</con2:path>
                                                </con2:param>
                                                <con2:param name="outboundServiceName">
                                                    <con2:path>fn:concat(fn:tokenize($outboundContext/@name, "\$")[last()-2],".",data($NC_operationName))</con2:path>
                                                </con2:param>
                                                <con2:param name="processName">
                                                    <con2:path>fn:concat(fn:tokenize($inbound/@name, "\$")[last()],".",$incomingHeader/header:HeaderIn/header:operation/text())</con2:path>
                                                </con2:param>
                                                <con2:param name="eventStatus">
                                                    <con2:path>"SUCCESS"</con2:path>
                                                </con2:param>
                                                <con2:param name="layerName">
                                                    <con2:path>"ESB"</con2:path>
                                                </con2:param>
                                                <con2:param name="flowID">
                                                    <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="inputElement">
                                                    <con2:path>if(data($incomingHeader/cor:debugFlag)="true") then
       &lt;Body>&lt;backendResponse>{data($body)}&lt;/backendResponse>&lt;/Body>
       else
        &lt;Body/></con2:path>
                                                </con2:param>
                                            </con2:xqueryTransform>
                                        </con1:expr>
                                    </con1:replace>
                                </con3:outboundTransform>
                            </con3:route>
                        </con1:responseTransform>
                    </con1:wsCallout>
                </con:actions>
            </con:stage>
            <con:stage id="_StageId-N53edf6a2.6211d480.0.18b7ecd41d6.N7faf" name="Call to Resend Notification">
                <con:context>
                    <con2:userNsDecl prefix="cor" namespace="http://soa.o2.co.uk/coredata_1"/>
                    <con2:userNsDecl prefix="header" namespace="http://telefonica.com/globalIntegration/header"/>
                </con:context>
                <con:actions>
                    <con1:wsCallout>
                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fac</con2:id>
                        <con1:service ref="DynamicNcRouter/proxyservices/DynamicNcRouter" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con1:request>
                            <con1:body wrapped="true">body</con1:body>
                            <con1:header>incomingHeader</con1:header>
                        </con1:request>
                        <con1:response>
                            <con1:body wrapped="true">body</con1:body>
                        </con1:response>
                        <con1:requestTransform>
                            <con1:assign varName="NC2_relativePath">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fa9</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn:concat(data($configXML/URL1),data($enotificationRecordId),data($configXML/resend))</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:assign varName="queryparameters">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fa6</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>&lt;http:query-parameters xmlns:http="http://www.bea.com/wli/sb/transports/http">
&lt;http:parameter name="channel" value="{data($commsChannelValue)}"/>
&lt;/http:query-parameters></con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:replace varName="body" contents-only="true">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fa3</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="DynamicNcRouter/transformations/RequestConstructionToDynamicRouting"/>
                                        <con2:param name="http-method">
                                            <con2:path>$configXML/POST_method</con2:path>
                                        </con2:param>
                                        <con2:param name="addtionalheaders">
                                            <con2:path>&lt;a/></con2:path>
                                        </con2:param>
                                        <con2:param name="payload">
                                            <con2:path>&lt;a/></con2:path>
                                        </con2:param>
                                        <con2:param name="queryparameters">
                                            <con2:path>if(fn:exists(data($queryparameters)))then
$queryparameters
else &lt;a/></con2:path>
                                        </con2:param>
                                        <con2:param name="relativePath">
                                            <con2:path>&lt;a>{$NC2_relativePath}&lt;/a></con2:path>
                                        </con2:param>
                                        <con2:param name="operation">
                                            <con2:path>$configXML/Operation2</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:replace>
                            <con1:assign varName="NC_operationName">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7fa0</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>data($body/DynamicRoutingRequest/operation)</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:transport-headers>
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f9d</con2:id>
                                <con1:header-set>outbound-request</con1:header-set>
                                <con1:header value="expression" name="jsessionValue">
                                    <con2:xqueryText>data($jsessionValue)</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="aviValue">
                                    <con2:xqueryText>data($aviValue)</con2:xqueryText>
                                </con1:header>
                            </con1:transport-headers>
                            <con1:ifThenElse>
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f93</con2:id>
                                <con1:case id="_BranchId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f92">
                                    <con1:condition>
                                        <con2:xqueryText>exists(data($jsessionValue) or data($aviValue))</con2:xqueryText>
                                    </con1:condition>
                                    <con1:actions>
                                        <con1:replace varName="header">
                                            <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f8f</con2:id>
                                            <con1:location>
                                                <con2:xpathText>.</con2:xpathText>
                                            </con1:location>
                                            <con1:expr>
                                                <con2:xqueryTransform>
                                                    <con2:resource ref="CommonResources/transformations/ConstructCookieOutboundHeader"/>
                                                    <con2:param name="jsessionValue">
                                                        <con2:path>$jsessionValue</con2:path>
                                                    </con2:param>
                                                    <con2:param name="header">
                                                        <con2:path>$incomingHeader</con2:path>
                                                    </con2:param>
                                                    <con2:param name="aviValue">
                                                        <con2:path>$aviValue</con2:path>
                                                    </con2:param>
                                                </con2:xqueryTransform>
                                            </con1:expr>
                                        </con1:replace>
                                    </con1:actions>
                                </con1:case>
                                <con1:default/>
                            </con1:ifThenElse>
                            <con1:assign varName="outboundContext">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f8c</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>$outbound</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con3:route>
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f87</con2:id>
                                <con3:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                <con3:operation>execute</con3:operation>
                                <con3:outboundTransform>
                                    <con1:routing-options>
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f84</con2:id>
                                        <con1:mode>request</con1:mode>
                                        <con1:qualityOfService>best-effort</con1:qualityOfService>
                                    </con1:routing-options>
                                    <con1:replace varName="body" contents-only="true">
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f81</con2:id>
                                        <con1:location>
                                            <con2:xpathText>.</con2:xpathText>
                                        </con1:location>
                                        <con1:expr>
                                            <con2:xqueryTransform>
                                                <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                                <con2:param name="messageID">
                                                    <con2:path>$messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="eventType">
                                                    <con2:path>"OUTBOUND:HEADER"</con2:path>
                                                </con2:param>
                                                <con2:param name="serviceName">
                                                    <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                                </con2:param>
                                                <con2:param name="inputSummary">
                                                    <con2:path>"SampleSB_Headers_Request"</con2:path>
                                                </con2:param>
                                                <con2:param name="inputLevel">
                                                    <con2:path>1</con2:path>
                                                </con2:param>
                                                <con2:param name="execID">
                                                    <con2:path>$incomingHeader/header:HeaderIn/header:execId/text()</con2:path>
                                                </con2:param>
                                                <con2:param name="eventCode">
                                                    <con2:path>""</con2:path>
                                                </con2:param>
                                                <con2:param name="outboundServiceName">
                                                    <con2:path>fn:concat(fn:tokenize($outboundContext/@name, "\$")[last()],".",data($NC_operationName))</con2:path>
                                                </con2:param>
                                                <con2:param name="processName">
                                                    <con2:path>fn:concat(fn:tokenize($inbound/@name, "\$")[last()],".",$incomingHeader/header:HeaderIn/header:operation/text())</con2:path>
                                                </con2:param>
                                                <con2:param name="eventStatus">
                                                    <con2:path>""</con2:path>
                                                </con2:param>
                                                <con2:param name="layerName">
                                                    <con2:path>"ESB"</con2:path>
                                                </con2:param>
                                                <con2:param name="flowID">
                                                    <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="inputElement">
                                                    <con2:path>$header/header:HeaderIn</con2:path>
                                                </con2:param>
                                            </con2:xqueryTransform>
                                        </con1:expr>
                                    </con1:replace>
                                </con3:outboundTransform>
                            </con3:route>
                            <con3:route>
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f7e</con2:id>
                                <con3:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                <con3:operation>execute</con3:operation>
                                <con3:outboundTransform>
                                    <con1:routing-options>
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f7b</con2:id>
                                        <con1:mode>request</con1:mode>
                                        <con1:qualityOfService>best-effort</con1:qualityOfService>
                                    </con1:routing-options>
                                    <con1:replace varName="body" contents-only="true">
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f78</con2:id>
                                        <con1:location>
                                            <con2:xpathText>.</con2:xpathText>
                                        </con1:location>
                                        <con1:expr>
                                            <con2:xqueryTransform>
                                                <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                                <con2:param name="messageID">
                                                    <con2:path>$messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="eventType">
                                                    <con2:path>"OUTBOUND:BODY"</con2:path>
                                                </con2:param>
                                                <con2:param name="serviceName">
                                                    <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                                </con2:param>
                                                <con2:param name="inputSummary">
                                                    <con2:path>"SampleSB_Body_Request"</con2:path>
                                                </con2:param>
                                                <con2:param name="inputLevel">
                                                    <con2:path>1</con2:path>
                                                </con2:param>
                                                <con2:param name="execID">
                                                    <con2:path>$incomingHeader/header:HeaderIn/header:execId/text()</con2:path>
                                                </con2:param>
                                                <con2:param name="eventCode">
                                                    <con2:path>""</con2:path>
                                                </con2:param>
                                                <con2:param name="outboundServiceName">
                                                    <con2:path>fn:concat(fn:tokenize($outboundContext/@name, "\$")[last()],".",data($NC_operationName))</con2:path>
                                                </con2:param>
                                                <con2:param name="processName">
                                                    <con2:path>fn:concat(fn:tokenize($inbound/@name, "\$")[last()],".",$incomingHeader/header:HeaderIn/header:operation/text())</con2:path>
                                                </con2:param>
                                                <con2:param name="eventStatus">
                                                    <con2:path>""</con2:path>
                                                </con2:param>
                                                <con2:param name="layerName">
                                                    <con2:path>"ESB"</con2:path>
                                                </con2:param>
                                                <con2:param name="flowID">
                                                    <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="inputElement">
                                                    <con2:path>if(data($incomingHeader/cor:debugFlag)="true") then
&lt;Body>{$body/*}&lt;/Body>
else
&lt;Body/></con2:path>
                                                </con2:param>
                                            </con2:xqueryTransform>
                                        </con1:expr>
                                    </con1:replace>
                                </con3:outboundTransform>
                            </con3:route>
                            <con1:assign varName="initExecBackend">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f75</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>(current-dateTime() - xs:dateTime("1970-01-01T00:00:00-00:00")) div xs:dayTimeDuration('PT0.001S')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                        </con1:requestTransform>
                        <con1:responseTransform>
                            <con1:assign varName="jsessionValue">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f72</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>if(fn:exists(data($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="jsessionValue"]/@value)))then
fn-bea:inlinedXML($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="jsessionValue"]/@value)
else ""</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:assign varName="aviValue">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f6f</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>if(fn:exists(data($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="aviValue"]/@value)))then
fn-bea:inlinedXML($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="aviValue"]/@value)
else ""</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:assign varName="backendJsession">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f6c</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>if(fn:exists(data($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="backendJsession"]/@value)))then
fn-bea:inlinedXML($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="backendJsession"]/@value)
else ""</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:assign varName="backendAvi">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f69</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>if(fn:exists(data($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="backendAvi"]/@value)))then
fn-bea:inlinedXML($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="backendAvi"]/@value)
else ""</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:ifThenElse>
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f62</con2:id>
                                <con1:case id="_BranchId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f61">
                                    <con1:condition>
                                        <con2:xqueryText>fn:exists($body/DynamicNcRouterFault/ctx:fault)
or
fn:exists($body/DynamicNcRouterFault/fault)
or 
((fn:contains(fn:normalize-space(fn-bea:serialize(data($body))),"errorCode")) and ((fn:contains(fn:normalize-space(fn-bea:serialize(data($body))),"userMessage")) or (fn:contains(fn:normalize-space(fn-bea:serialize(data($body))),"stacktrace"))))</con2:xqueryText>
                                    </con1:condition>
                                    <con1:actions>
                                        <con1:Error>
                                            <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f5e</con2:id>
                                            <con1:errCode>NC_Router_error</con1:errCode>
                                        </con1:Error>
                                    </con1:actions>
                                </con1:case>
                                <con1:default/>
                            </con1:ifThenElse>
                            <con1:assign varName="tExecBackend">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f5b</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>xs:integer((current-dateTime() - xs:dateTime("1970-01-01T00:00:00-00:00")) div xs:dayTimeDuration('PT0.001S')) - xs:integer($initExecBackend)</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:replace varName="header">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f58</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="CommonResources/transformations/ConstructResponseSOAPHeaderForCookie"/>
                                        <con2:param name="inbound_header">
                                            <con2:path>true()</con2:path>
                                        </con2:param>
                                        <con2:param name="onError">
                                            <con2:path>false()</con2:path>
                                        </con2:param>
                                        <con2:param name="jsessionValue">
                                            <con2:path>$backendJsession</con2:path>
                                        </con2:param>
                                        <con2:param name="inbound">
                                            <con2:path>$inbound</con2:path>
                                        </con2:param>
                                        <con2:param name="header">
                                            <con2:path>$incomingHeader</con2:path>
                                        </con2:param>
                                        <con2:param name="aviValue">
                                            <con2:path>$backendAvi</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:replace>
                            <con1:assign varName="outboundContext">
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f55</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>if(fn:exists(data($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="outbound_value"]/@value)))then
fn-bea:inlinedXML($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="outbound_value"]/@value)
else ""</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con3:route>
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f48</con2:id>
                                <con3:service ref="ArchitectureServices/ExecutionLogService/ProxyServices/ExecutionLogServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                <con3:operation>execute</con3:operation>
                                <con3:outboundTransform>
                                    <con1:routing-options>
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f3f</con2:id>
                                        <con1:mode>request</con1:mode>
                                        <con1:qualityOfService>best-effort</con1:qualityOfService>
                                    </con1:routing-options>
                                    <con1:replace varName="body" contents-only="true">
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f3c</con2:id>
                                        <con1:location>
                                            <con2:xpathText>.</con2:xpathText>
                                        </con1:location>
                                        <con1:expr>
                                            <con2:xqueryTransform>
                                                <con2:resource ref="CommonResources/transformations/ExecutionLogInfo"/>
                                                <con2:param name="tExecBackend">
                                                    <con2:path>$tExecBackend</con2:path>
                                                </con2:param>
                                                <con2:param name="incomingHeader">
                                                    <con2:path>$incomingHeader</con2:path>
                                                </con2:param>
                                                <con2:param name="resultCode">
                                                    <con2:path>"OK"</con2:path>
                                                </con2:param>
                                                <con2:param name="messageID">
                                                    <con2:path>$messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="error">
                                                    <con2:path>&lt;error/></con2:path>
                                                </con2:param>
                                                <con2:param name="layer">
                                                    <con2:path>"ESB"</con2:path>
                                                </con2:param>
                                                <con2:param name="errorText">
                                                    <con2:path>""</con2:path>
                                                </con2:param>
                                                <con2:param name="serviceBackend">
                                                    <con2:path>fn:tokenize($outboundContext/@name, "\$")[last()]</con2:path>
                                                </con2:param>
                                                <con2:param name="operationBackend">
                                                    <con2:path>$outboundContext/ctx:service/ctx:operation/text()</con2:path>
                                                </con2:param>
                                                <con2:param name="service">
                                                    <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                                </con2:param>
                                                <con2:param name="outboundContext">
                                                    <con2:path>$outboundContext</con2:path>
                                                </con2:param>
                                                <con2:param name="header">
                                                    <con2:path>$header</con2:path>
                                                </con2:param>
                                                <con2:param name="inboundContext">
                                                    <con2:path>$inbound</con2:path>
                                                </con2:param>
                                                <con2:param name="execStartTime">
                                                    <con2:path>$execStartTime</con2:path>
                                                </con2:param>
                                            </con2:xqueryTransform>
                                        </con1:expr>
                                    </con1:replace>
                                </con3:outboundTransform>
                            </con3:route>
                            <con3:route>
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f45</con2:id>
                                <con3:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                <con3:operation>execute</con3:operation>
                                <con3:outboundTransform>
                                    <con1:routing-options>
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f39</con2:id>
                                        <con1:mode>request</con1:mode>
                                        <con1:qualityOfService>best-effort</con1:qualityOfService>
                                    </con1:routing-options>
                                    <con1:replace varName="body" contents-only="true">
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f36</con2:id>
                                        <con1:location>
                                            <con2:xpathText>.</con2:xpathText>
                                        </con1:location>
                                        <con1:expr>
                                            <con2:xqueryTransform>
                                                <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                                <con2:param name="messageID">
                                                    <con2:path>$messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="eventType">
                                                    <con2:path>"INBOUND:HEADER"</con2:path>
                                                </con2:param>
                                                <con2:param name="serviceName">
                                                    <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                                </con2:param>
                                                <con2:param name="inputSummary">
                                                    <con2:path>"SampleSB_Headers_Response"</con2:path>
                                                </con2:param>
                                                <con2:param name="inputLevel">
                                                    <con2:path>1</con2:path>
                                                </con2:param>
                                                <con2:param name="execID">
                                                    <con2:path>$header/header:HeaderOut/header:execId/text()</con2:path>
                                                </con2:param>
                                                <con2:param name="eventCode">
                                                    <con2:path>""</con2:path>
                                                </con2:param>
                                                <con2:param name="outboundServiceName">
                                                    <con2:path>fn:concat(fn:tokenize($outboundContext/@name, "\$")[last()-2],".",data($NC_operationName))</con2:path>
                                                </con2:param>
                                                <con2:param name="processName">
                                                    <con2:path>fn:concat(fn:tokenize($inbound/@name, "\$")[last()],".",$incomingHeader/header:HeaderIn/header:operation/text())</con2:path>
                                                </con2:param>
                                                <con2:param name="eventStatus">
                                                    <con2:path>"SUCCESS"</con2:path>
                                                </con2:param>
                                                <con2:param name="layerName">
                                                    <con2:path>"ESB"</con2:path>
                                                </con2:param>
                                                <con2:param name="flowID">
                                                    <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="inputElement">
                                                    <con2:path>$header/header:HeaderOut</con2:path>
                                                </con2:param>
                                            </con2:xqueryTransform>
                                        </con1:expr>
                                    </con1:replace>
                                </con3:outboundTransform>
                            </con3:route>
                            <con3:route>
                                <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f42</con2:id>
                                <con3:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                <con3:operation>execute</con3:operation>
                                <con3:outboundTransform>
                                    <con1:routing-options>
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f33</con2:id>
                                        <con1:mode>request</con1:mode>
                                        <con1:qualityOfService>best-effort</con1:qualityOfService>
                                    </con1:routing-options>
                                    <con1:replace varName="body" contents-only="true">
                                        <con2:id>_ActionId-N53edf6a2.6211d480.0.18b7ecd41d6.N7f30</con2:id>
                                        <con1:location>
                                            <con2:xpathText>.</con2:xpathText>
                                        </con1:location>
                                        <con1:expr>
                                            <con2:xqueryTransform>
                                                <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                                <con2:param name="messageID">
                                                    <con2:path>$messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="eventType">
                                                    <con2:path>"INBOUND:BODY"</con2:path>
                                                </con2:param>
                                                <con2:param name="serviceName">
                                                    <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                                </con2:param>
                                                <con2:param name="inputSummary">
                                                    <con2:path>"SampleSB_BODY_Response"</con2:path>
                                                </con2:param>
                                                <con2:param name="inputLevel">
                                                    <con2:path>1</con2:path>
                                                </con2:param>
                                                <con2:param name="execID">
                                                    <con2:path>$incomingHeader/header:HeaderIn/header:execId/text()</con2:path>
                                                </con2:param>
                                                <con2:param name="eventCode">
                                                    <con2:path>""</con2:path>
                                                </con2:param>
                                                <con2:param name="outboundServiceName">
                                                    <con2:path>fn:concat(fn:tokenize($outboundContext/@name, "\$")[last()-2],".",data($NC_operationName))</con2:path>
                                                </con2:param>
                                                <con2:param name="processName">
                                                    <con2:path>fn:concat(fn:tokenize($inbound/@name, "\$")[last()],".",$incomingHeader/header:HeaderIn/header:operation/text())</con2:path>
                                                </con2:param>
                                                <con2:param name="eventStatus">
                                                    <con2:path>"SUCCESS"</con2:path>
                                                </con2:param>
                                                <con2:param name="layerName">
                                                    <con2:path>"ESB"</con2:path>
                                                </con2:param>
                                                <con2:param name="flowID">
                                                    <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                                </con2:param>
                                                <con2:param name="inputElement">
                                                    <con2:path>if(data($incomingHeader/cor:debugFlag)="true") then
       &lt;Body>&lt;backendResponse>{data($body)}&lt;/backendResponse>&lt;/Body>
       else
        &lt;Body/></con2:path>
                                                </con2:param>
                                            </con2:xqueryTransform>
                                        </con1:expr>
                                    </con1:replace>
                                </con3:outboundTransform>
                            </con3:route>
                        </con1:responseTransform>
                    </con1:wsCallout>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="response" name="response-N53edf6a2.N3b0158.0.18b36bcce0e.N7f47">
            <con:stage id="_StageId-N53edf6a2.N3b0158.0.18b36bcce0e.N7f45" name="Stage1">
                <con:context/>
                <con:actions>
                    <con1:replace varName="body" contents-only="true">
                        <con2:id>_ActionId-N53e1bf34.N52dac89a.0.18b9448188e.N7fcd</con2:id>
                        <con1:location>
                            <con2:xpathText>.</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xqueryText>""</con2:xqueryText>
                        </con1:expr>
                    </con1:replace>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N53ede7ac.N193d93f5.0.18ba383078a.N8000">
            <con:stage id="_StageId-N53ede7ac.N193d93f5.0.18ba383078a.N7e95" name="Error Handler" xmlns:con1="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con4="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config">
                <con:comment>logs the fault thrown by service being called in the 
flow and osb fault.</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="head" namespace="http://telefonica.com/globalIntegration/header"/>
                    <con2:userNsDecl prefix="con1" namespace="http://www.bea.com/wli/sb/stages/transform/config"/>
                    <con2:userNsDecl prefix="tns" namespace="http://xmlns.oracle.com/userid/SubscribedProducts/SubscribedProductsByPhoneNoSplitJoin"/>
                    <con2:userNsDecl prefix="header" namespace="http://telefonica.com/globalIntegration/header"/>
                    <con2:userNsDecl prefix="xcore" namespace="http://soa.o2.co.uk/coredata_1"/>
                </con:context>
                <con:actions>
                    <con3:assign varName="tExecBackend" xmlns:con5="http://www.bea.com/wli/sb/stages/publish/config">
                        <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e94</con2:id>
                        <con3:expr>
                            <con2:xqueryText>xs:integer((current-dateTime() - xs:dateTime("1970-01-01T00:00:00-00:00")) div xs:dayTimeDuration('PT0.001S')) - xs:integer($initExecBackend)</con2:xqueryText>
                        </con3:expr>
                    </con3:assign>
                    <con3:assign varName="outboundContext" xmlns:con1="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con5="http://www.bea.com/wli/sb/typesystem/config">
                        <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e93</con2:id>
                        <con3:expr>
                            <con2:xqueryText>if(fn:exists(data($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="outbound_value"]/@value)))then
fn-bea:inlinedXML($outbound/ctx:transport/ctx:response/tp:headers/tp:user-header[@name="outbound_value"]/@value)
else if(fn:exists($body/DynamicNcRouterFault/outbound/ctx:endpoint))then
$body/DynamicNcRouterFault/outbound/ctx:endpoint
else
$outboundContext</con2:xqueryText>
                        </con3:expr>
                    </con3:assign>
                    <con3:assign varName="inboundContext" xmlns:con1="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con5="http://www.bea.com/wli/sb/stages/publish/config">
                        <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e92</con2:id>
                        <con3:expr>
                            <con2:xqueryText>$inbound</con2:xqueryText>
                        </con3:expr>
                    </con3:assign>
                    <con1:replace varName="header" contents-only="false" xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config" xmlns:ser="http://www.bea.com/wli/sb/services" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:env="http://www.bea.com/wli/config/env" xmlns:http="http://www.bea.com/wli/sb/transports/http" xmlns:oper="http://xmlns.oracle.com/servicebus/pipeline/operations" xmlns:tran="http://www.bea.com/wli/sb/transports" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
                        <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e91</con2:id>
                        <con1:location>
                            <con2:xpathText>.</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xqueryTransform>
                                <con2:resource ref="CommonResources/transformations/ConstructResponseSOAPHeaderForCookie"/>
                                <con2:param name="inbound_header">
                                    <con2:path>true()</con2:path>
                                </con2:param>
                                <con2:param name="onError">
                                    <con2:path>true()</con2:path>
                                </con2:param>
                                <con2:param name="jsessionValue">
                                    <con2:path>$backendJsession</con2:path>
                                </con2:param>
                                <con2:param name="inbound">
                                    <con2:path>$inbound</con2:path>
                                </con2:param>
                                <con2:param name="header">
                                    <con2:path>$incomingHeader</con2:path>
                                </con2:param>
                                <con2:param name="aviValue">
                                    <con2:path>$backendAvi</con2:path>
                                </con2:param>
                            </con2:xqueryTransform>
                        </con1:expr>
                    </con1:replace>
                    <con5:ifThenElse xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                        <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e90</con6:id>
                        <con2:case id="_BranchId-N53ede7ac.N193d93f5.0.18ba383078a.N7e8f">
                            <con2:condition>
                                <con6:xqueryText xmlns:con6="http://www.bea.com/wli/sb/stages/config">data($fault/ctx:errorCode)="NC_Router_error"</con6:xqueryText>
                            </con2:condition>
                            <con2:actions>
                                <con4:assign varName="NCRouterErr" xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config">
                                    <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e8e</con6:id>
                                    <con2:expr>
                                        <con6:xqueryText xmlns:con6="http://www.bea.com/wli/sb/stages/config">if((fn:starts-with(fn:normalize-space(fn-bea:serialize(data($body/DynamicNcRouterFault/fault))),"{"))
and ((fn:contains(fn:normalize-space(fn-bea:serialize(data($body/DynamicNcRouterFault/fault))),"errorCode")) 
and ((fn:contains(fn:normalize-space(fn-bea:serialize(data($body/DynamicNcRouterFault/fault))),"userMessage")) 
or (fn:contains(fn:normalize-space(fn-bea:serialize(data($body/DynamicNcRouterFault/fault))),"stacktrace")))))
then
&lt;a>{data($body/DynamicNcRouterFault/fault)}&lt;/a>
else ""</con6:xqueryText>
                                    </con2:expr>
                                </con4:assign>
                                <con2:ifThenElse>
                                    <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e8d</con6:id>
                                    <con2:case id="_BranchId-N53ede7ac.N193d93f5.0.18ba383078a.N7e8c">
                                        <con2:condition>
                                            <con6:xqueryText xmlns:con6="http://www.bea.com/wli/sb/stages/config">exists($NCRouterErr) and data($NCRouterErr) ne ''</con6:xqueryText>
                                        </con2:condition>
                                        <con2:actions/>
                                    </con2:case>
                                    <con2:default>
                                        <con5:replace varName="fault" contents-only="false" xmlns:con1="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config">
                                            <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e8b</con2:id>
                                            <con4:location>
                                                <con:xpathText xmlns:con="http://www.bea.com/wli/sb/stages/config">.</con:xpathText>
                                            </con4:location>
                                            <con4:expr>
                                                <con2:xqueryText>if(exists($body/DynamicNcRouterFault/ctx:fault)) then
$body/DynamicNcRouterFault/ctx:fault
else
$fault</con2:xqueryText>
                                            </con4:expr>
                                        </con5:replace>
                                    </con2:default>
                                </con2:ifThenElse>
                            </con2:actions>
                        </con2:case>
                        <con2:default/>
                    </con5:ifThenElse>
                    <con3:ifThenElse>
                        <con2:comment/>
                        <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e8a</con2:id>
                        <con3:case id="_BranchId-N53ede7ac.N193d93f5.0.18ba383078a.N7e89">
                            <con3:condition>
                                <con2:xqueryText>(exists($NCRouterErr) and data($NCRouterErr) ne '')</con2:xqueryText>
                            </con3:condition>
                            <con3:actions>
                                <con1:javaCallout varName="NCErrResp" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con5="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config">
                                    <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e88</con2:id>
                                    <con1:archive ref="Utility/convertXmlJson/Convert_XML_JSON"/>
                                    <con1:className>uk.co.o2.esb.conversion.ConversionJSONtoXML</con1:className>
                                    <con1:method>public static java.lang.String formatJson(java.lang.String)</con1:method>
                                    <con1:expr>
                                        <con2:xqueryText>data($NCRouterErr)</con2:xqueryText>
                                    </con1:expr>
                                    <con1:return-param-as-ref>false</con1:return-param-as-ref>
                                </con1:javaCallout>
                                <con4:assign varName="NCxmlErrResp" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config">
                                    <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e87</con5:id>
                                    <con2:expr>
                                        <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">fn-bea:inlinedXML(fn-bea:serialize(data($NCErrResp)))</con5:xqueryText>
                                    </con2:expr>
                                </con4:assign>
                                <con2:assign varName="exceptionDetails" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config">
                                    <con7:id xmlns:con7="http://www.bea.com/wli/sb/stages/config">_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e86</con7:id>
                                    <con5:expr>
                                        <con7:xqueryText xmlns:con7="http://www.bea.com/wli/sb/stages/config"><![CDATA[<Fault>
<detail>
<MessageFault>
<exceptionCode>
{
if(exists($outbound/ctx:transport/ctx:response/http:http-response-code)) then
data($outbound/ctx:transport/ctx:response/http:http-response-code)
else if(exists($NCxmlErrResp/errorCode))then
data($NCxmlErrResp/errorCode)
else if(exists($NCxmlErrResp/error/errorCode))then
data($NCxmlErrResp/error/errorCode)
else if(exists($outboundContext/ctx:transport/ctx:response/http:http-response-code)) then
data($outboundContext/ctx:transport/ctx:response/http:http-response-code)
else data($fault/ctx:errorCode)
}
</exceptionCode>
<exceptionDetail>
{
if(exists($NCxmlErrResp/error/userMessage/message)) then
data($NCxmlErrResp/error/userMessage/message)
else if(exists($NCxmlErrResp/userMessage/message)) then
data($NCxmlErrResp/userMessage/message)
else if(exists($NCxmlErrResp/userMessage)) then
data($NCxmlErrResp/userMessage)
else if(exists($NCxmlErrResp/validationElements/validationElement[1]/message)) then
data($NCxmlErrResp/validationElements/validationElement[1]/message)
else data($fault/ctx:reason)
}
</exceptionDetail>
</MessageFault>
</detail>
</Fault>]]></con7:xqueryText>
                                    </con5:expr>
                                </con2:assign>
                                <con1:route xmlns:con1="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con5="http://www.bea.com/wli/sb/typesystem/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
                                    <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e85</con2:id>
                                    <con6:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con6:locked>
                                    <con1:service ref="ArchitectureServices/ExecutionLogService/ProxyServices/ExecutionLogServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                    <con1:operation>execute</con1:operation>
                                    <con1:outboundTransform>
                                        <con3:routing-options xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config">
                                            <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e84</con2:id>
                                            <con6:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con6:locked>
                                            <con3:mode>request</con3:mode>
                                            <con3:qualityOfService>best-effort</con3:qualityOfService>
                                        </con3:routing-options>
                                        <con3:replace varName="body" contents-only="true" xmlns:con1="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config">
                                            <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e83</con2:id>
                                            <con3:location>
                                                <con2:xpathText xmlns:con5="http://www.bea.com/wli/sb/stages/config">.</con2:xpathText>
                                            </con3:location>
                                            <con3:expr>
                                                <con2:xqueryTransform>
                                                    <con2:resource ref="CommonResources/transformations/ExecutionLogInfo"/>
                                                    <con2:param name="tExecBackend">
                                                        <con2:path>$tExecBackend</con2:path>
                                                    </con2:param>
                                                    <con2:param name="incomingHeader">
                                                        <con2:path>$incomingHeader</con2:path>
                                                    </con2:param>
                                                    <con2:param name="resultCode">
                                                        <con2:path>"KO"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="messageID">
                                                        <con2:path>$messageID</con2:path>
                                                    </con2:param>
                                                    <con2:param name="error">
                                                        <con2:path>$exceptionDetails</con2:path>
                                                    </con2:param>
                                                    <con2:param name="layer">
                                                        <con2:path>"ESB"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="errorText">
                                                        <con2:path>fn-bea:serialize($exceptionDetails)</con2:path>
                                                    </con2:param>
                                                    <con2:param name="serviceBackend">
                                                        <con2:path>fn:tokenize($outboundContext/@name, "\$")[last()]</con2:path>
                                                    </con2:param>
                                                    <con2:param name="operationBackend">
                                                        <con2:path>$outboundContext/ctx:service/ctx:operation/text()</con2:path>
                                                    </con2:param>
                                                    <con2:param name="service">
                                                        <con2:path>fn:tokenize($mainInbound/@name, "\$")[last()]</con2:path>
                                                    </con2:param>
                                                    <con2:param name="outboundContext">
                                                        <con2:path>$outboundContext</con2:path>
                                                    </con2:param>
                                                    <con2:param name="header">
                                                        <con2:path>$header</con2:path>
                                                    </con2:param>
                                                    <con2:param name="inboundContext">
                                                        <con2:path>$inbound</con2:path>
                                                    </con2:param>
                                                    <con2:param name="execStartTime">
                                                        <con2:path>$execStartTime</con2:path>
                                                    </con2:param>
                                                </con2:xqueryTransform>
                                            </con3:expr>
                                        </con3:replace>
                                    </con1:outboundTransform>
                                </con1:route>
                                <con4:route xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con5="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config">
                                    <con1:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e82</con1:id>
                                    <con1:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con1:locked>
                                    <con4:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                    <con4:operation>execute</con4:operation>
                                    <con4:outboundTransform>
                                        <con3:routing-options xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config">
                                            <con1:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e81</con1:id>
                                            <con1:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con1:locked>
                                            <con3:mode>request</con3:mode>
                                            <con3:qualityOfService>best-effort</con3:qualityOfService>
                                        </con3:routing-options>
                                        <con1:replace varName="body" contents-only="true" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config">
                                            <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e80</con2:id>
                                            <con1:location>
                                                <con2:xpathText xmlns:con6="http://www.bea.com/wli/sb/stages/config">.</con2:xpathText>
                                            </con1:location>
                                            <con1:expr>
                                                <con2:xqueryTransform>
                                                    <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                                    <con2:param name="messageID">
                                                        <con2:path>$messageID</con2:path>
                                                    </con2:param>
                                                    <con2:param name="eventType">
                                                        <con2:path>"INBOUND:HEADER"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="serviceName">
                                                        <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                                    </con2:param>
                                                    <con2:param name="inputSummary">
                                                        <con2:path>"SendPortNotification_INBOUND_HEADER_Response"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="inputLevel">
                                                        <con2:path>1</con2:path>
                                                    </con2:param>
                                                    <con2:param name="execID">
                                                        <con2:path>$incomingHeader/header:HeaderIn/header:execId/text()</con2:path>
                                                    </con2:param>
                                                    <con2:param name="eventCode">
                                                        <con2:path>""</con2:path>
                                                    </con2:param>
                                                    <con2:param name="outboundServiceName">
                                                        <con2:path>fn:concat(fn:tokenize($outboundContext/@name, "\$")[last()-2],".",$outboundContext/ctx:service/ctx:operation/text())</con2:path>
                                                    </con2:param>
                                                    <con2:param name="processName">
                                                        <con2:path>fn:concat(fn:tokenize($inbound/@name, "\$")[last()],".",$incomingHeader/header:HeaderIn/header:operation/text())</con2:path>
                                                    </con2:param>
                                                    <con2:param name="eventStatus">
                                                        <con2:path>"FAULT"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="layerName">
                                                        <con2:path>"ESB"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="flowID">
                                                        <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                                    </con2:param>
                                                    <con2:param name="inputElement">
                                                        <con2:path>$header/header:HeaderOut</con2:path>
                                                    </con2:param>
                                                </con2:xqueryTransform>
                                            </con1:expr>
                                        </con1:replace>
                                    </con4:outboundTransform>
                                </con4:route>
                                <con4:route xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con5="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config">
                                    <con1:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e7f</con1:id>
                                    <con1:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con1:locked>
                                    <con4:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                    <con4:operation>execute</con4:operation>
                                    <con4:outboundTransform>
                                        <con3:routing-options xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config">
                                            <con1:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e7e</con1:id>
                                            <con1:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con1:locked>
                                            <con3:mode>request</con3:mode>
                                            <con3:qualityOfService>best-effort</con3:qualityOfService>
                                        </con3:routing-options>
                                        <con1:replace varName="body" contents-only="true" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config">
                                            <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e7d</con2:id>
                                            <con1:location>
                                                <con2:xpathText xmlns:con6="http://www.bea.com/wli/sb/stages/config">.</con2:xpathText>
                                            </con1:location>
                                            <con1:expr>
                                                <con2:xqueryTransform>
                                                    <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                                    <con2:param name="messageID">
                                                        <con2:path>$messageID</con2:path>
                                                    </con2:param>
                                                    <con2:param name="eventType">
                                                        <con2:path>"INBOUND:FAULT"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="serviceName">
                                                        <con2:path>fn:tokenize($inbound/@name, "\$")[last()]</con2:path>
                                                    </con2:param>
                                                    <con2:param name="inputSummary">
                                                        <con2:path>"SendPortNotification_FAULT_INBOUND"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="inputLevel">
                                                        <con2:path>1</con2:path>
                                                    </con2:param>
                                                    <con2:param name="execID">
                                                        <con2:path>$incomingHeader/header:HeaderIn/header:execId/text()</con2:path>
                                                    </con2:param>
                                                    <con2:param name="eventCode">
                                                        <con2:path>data($exceptionDetails/detail/MessageFault/exceptionCode)</con2:path>
                                                    </con2:param>
                                                    <con2:param name="outboundServiceName">
                                                        <con2:path>fn:concat(fn:tokenize($outboundContext/@name, "\$")[last()-2],".",$outboundContext/ctx:service/ctx:operation/text())</con2:path>
                                                    </con2:param>
                                                    <con2:param name="processName">
                                                        <con2:path>fn:concat(fn:tokenize($inbound/@name, "\$")[last()],".",$incomingHeader/header:HeaderIn/header:operation/text())</con2:path>
                                                    </con2:param>
                                                    <con2:param name="eventStatus">
                                                        <con2:path>"FAULT"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="layerName">
                                                        <con2:path>"ESB"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="flowID">
                                                        <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                                    </con2:param>
                                                    <con2:param name="inputElement">
                                                        <con2:path>if(data($NCRouterErr)) then
&lt;response>{data($NCRouterErr)}&lt;/response>
else
&lt;Body/></con2:path>
                                                    </con2:param>
                                                </con2:xqueryTransform>
                                            </con1:expr>
                                        </con1:replace>
                                    </con4:outboundTransform>
                                </con4:route>
                                <con5:javaCallout varName="errorMap" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                                    <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e7c</con2:id>
                                    <con1:archive ref="Utility/errormaphandling/errormaphandling"/>
                                    <con1:className>uk.co.o2.soa.sf.errormap.impl.FaultManagement</con1:className>
                                    <con1:method>public static java.lang.String retreiveDestErrorMessage(org.apache.xmlbeans.XmlObject, java.lang.String)</con1:method>
                                    <con1:expr>
                                        <con:xqueryText xmlns:con="http://www.bea.com/wli/sb/stages/config">$mainInbound</con:xqueryText>
                                    </con1:expr>
                                    <con1:expr>
                                        <con2:xqueryText>if(exists($NCxmlErrResp/userMessage/businessCode))then
data($NCxmlErrResp/userMessage/businessCode)
else if(exists($NCxmlErrResp/errorCode))then
data($NCxmlErrResp/errorCode)
else
data($outboundContext/ctx:transport/ctx:response/http:http-response-code)</con2:xqueryText>
                                    </con1:expr>
                                    <con1:return-param-as-ref>false</con1:return-param-as-ref>
                                </con5:javaCallout>
                            </con3:actions>
                        </con3:case>
                        <con3:case id="_BranchId-N53ede7ac.N193d93f5.0.18ba383078a.N7e7b">
                            <con3:condition>
                                <con2:xqueryText>fn:exists($fault/ctx:details/con1:ErrorResponseDetail/con1:detail) 
and 
fn:exists(data($fault/ctx:details/con1:ErrorResponseDetail/con1:http-response-code)) 
and 
(
fn:contains(fn:normalize-space(fn-bea:serialize(data($fault/ctx:details/con1:ErrorResponseDetail/con1:detail))),"stacktrace") 
or 
fn:contains(fn:normalize-space(fn-bea:serialize(data($fault/ctx:details/con1:ErrorResponseDetail/con1:detail))),"errorCode") 
or 
fn:contains(fn:normalize-space(fn-bea:serialize(data($fault/ctx:details/con1:ErrorResponseDetail/con1:detail))),"userMessage")
)</con2:xqueryText>
                            </con3:condition>
                            <con3:actions>
                                <con6:javaCallout varName="faultDetail" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con5="http://www.bea.com/wli/sb/stages/publish/config">
                                    <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e7a</con2:id>
                                    <con1:archive ref="Utility/commonutility/commonutility"/>
                                    <con1:className>uk.co.o2.soa.sf.converter.ConvertJSONtoXML</con1:className>
                                    <con1:method>public static java.lang.String convertJSONtoXML(java.lang.String)</con1:method>
                                    <con1:expr>
                                        <con2:xqueryText>data($fault/ctx:details/con1:ErrorResponseDetail/con1:detail)</con2:xqueryText>
                                    </con1:expr>
                                    <con1:return-param-as-ref>false</con1:return-param-as-ref>
                                </con6:javaCallout>
                                <con6:assign varName="NCxmlErrResp" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con5="http://www.bea.com/wli/sb/stages/publish/config">
                                    <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e79</con2:id>
                                    <con1:expr>
                                        <con2:xqueryText>fn-bea:inlinedXML(fn-bea:serialize($faultDetail))</con2:xqueryText>
                                    </con1:expr>
                                </con6:assign>
                                <con2:assign varName="exceptionDetails" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config">
                                    <con7:id xmlns:con7="http://www.bea.com/wli/sb/stages/config">_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e78</con7:id>
                                    <con5:expr>
                                        <con7:xqueryText xmlns:con7="http://www.bea.com/wli/sb/stages/config"><![CDATA[<Fault>
<detail>
<MessageFault>
<exceptionCode>
{
if(exists($fault/ctx:details/con1:ErrorResponseDetail/con1:http-response-code)) then
data($fault/ctx:details/con1:ErrorResponseDetail/con1:http-response-code)
else ''
}
</exceptionCode>
<exceptionDetail>
{
if(exists($NCxmlErrResp/error/userMessage/message)) then
data($NCxmlErrResp/error/userMessage/message)
else if(exists($NCxmlErrResp/userMessage/message)) then
data($NCxmlErrResp/userMessage/message)
else if(exists($NCxmlErrResp/userMessage)) then
data($NCxmlErrResp/userMessage)
else ''
}
</exceptionDetail>
</MessageFault>
</detail>
</Fault>]]></con7:xqueryText>
                                    </con5:expr>
                                </con2:assign>
                                <con1:route xmlns:con1="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con5="http://www.bea.com/wli/sb/typesystem/config">
                                    <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e77</con2:id>
                                    <con6:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con6:locked>
                                    <con1:service ref="ArchitectureServices/ExecutionLogService/ProxyServices/ExecutionLogServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                    <con1:operation>execute</con1:operation>
                                    <con1:outboundTransform>
                                        <con3:routing-options>
                                            <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e76</con2:id>
                                            <con6:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con6:locked>
                                            <con3:mode>request</con3:mode>
                                            <con3:qualityOfService>best-effort</con3:qualityOfService>
                                        </con3:routing-options>
                                        <con3:replace varName="body" contents-only="true" xmlns:con1="http://www.bea.com/wli/sb/stages/routing/config">
                                            <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e75</con2:id>
                                            <con3:location>
                                                <con2:xpathText xmlns:con5="http://www.bea.com/wli/sb/stages/config">.</con2:xpathText>
                                            </con3:location>
                                            <con3:expr>
                                                <con2:xqueryTransform>
                                                    <con2:resource ref="CommonResources/transformations/ExecutionLogInfo"/>
                                                    <con2:param name="tExecBackend">
                                                        <con2:path>$tExecBackend</con2:path>
                                                    </con2:param>
                                                    <con2:param name="incomingHeader">
                                                        <con2:path>$incomingHeader</con2:path>
                                                    </con2:param>
                                                    <con2:param name="resultCode">
                                                        <con2:path>"KO"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="messageID">
                                                        <con2:path>$messageID</con2:path>
                                                    </con2:param>
                                                    <con2:param name="error">
                                                        <con2:path>$exceptionDetails</con2:path>
                                                    </con2:param>
                                                    <con2:param name="layer">
                                                        <con2:path>"ESB"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="errorText">
                                                        <con2:path>fn-bea:serialize($exceptionDetails)</con2:path>
                                                    </con2:param>
                                                    <con2:param name="serviceBackend">
                                                        <con2:path>fn:tokenize($outboundContext/@name, "\$")[last()]</con2:path>
                                                    </con2:param>
                                                    <con2:param name="operationBackend">
                                                        <con2:path>$outboundContext/ctx:service/ctx:operation/text()</con2:path>
                                                    </con2:param>
                                                    <con2:param name="service">
                                                        <con2:path>fn:tokenize($mainInbound/@name, "\$")[last()]</con2:path>
                                                    </con2:param>
                                                    <con2:param name="outboundContext">
                                                        <con2:path>$outboundContext</con2:path>
                                                    </con2:param>
                                                    <con2:param name="header">
                                                        <con2:path>$header</con2:path>
                                                    </con2:param>
                                                    <con2:param name="inboundContext">
                                                        <con2:path>$inboundContext</con2:path>
                                                    </con2:param>
                                                    <con2:param name="execStartTime">
                                                        <con2:path>$execStartTime</con2:path>
                                                    </con2:param>
                                                </con2:xqueryTransform>
                                            </con3:expr>
                                        </con3:replace>
                                    </con1:outboundTransform>
                                </con1:route>
                                <con4:route xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con5="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config">
                                    <con1:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e74</con1:id>
                                    <con1:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con1:locked>
                                    <con4:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                    <con4:operation>execute</con4:operation>
                                    <con4:outboundTransform>
                                        <con3:routing-options>
                                            <con1:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e73</con1:id>
                                            <con1:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con1:locked>
                                            <con3:mode>request</con3:mode>
                                            <con3:qualityOfService>best-effort</con3:qualityOfService>
                                        </con3:routing-options>
                                        <con1:replace varName="body" contents-only="true" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config">
                                            <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e72</con2:id>
                                            <con1:location>
                                                <con2:xpathText xmlns:con6="http://www.bea.com/wli/sb/stages/config">.</con2:xpathText>
                                            </con1:location>
                                            <con1:expr>
                                                <con2:xqueryTransform>
                                                    <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                                    <con2:param name="messageID">
                                                        <con2:path>$messageID</con2:path>
                                                    </con2:param>
                                                    <con2:param name="eventType">
                                                        <con2:path>"INBOUND:HEADER"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="serviceName">
                                                        <con2:path>fn:tokenize($mainInbound/@name, "\$")[last()]</con2:path>
                                                    </con2:param>
                                                    <con2:param name="inputSummary">
                                                        <con2:path>"SendPortNotification_INBOUND_HEADER_Response"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="inputLevel">
                                                        <con2:path>1</con2:path>
                                                    </con2:param>
                                                    <con2:param name="execID">
                                                        <con2:path>$header/head:HeaderOut/head:execId/text()</con2:path>
                                                    </con2:param>
                                                    <con2:param name="eventCode">
                                                        <con2:path>""</con2:path>
                                                    </con2:param>
                                                    <con2:param name="outboundServiceName">
                                                        <con2:path>fn:concat(fn:tokenize($outboundContext/@name, "\$")[last()-2],".",$outboundContext/ctx:service/ctx:operation/text())</con2:path>
                                                    </con2:param>
                                                    <con2:param name="processName">
                                                        <con2:path>fn:concat(fn:tokenize($mainInbound/@name, "\$")[last()],".",$incomingHeader/head:HeaderIn/head:operation/text())</con2:path>
                                                    </con2:param>
                                                    <con2:param name="eventStatus">
                                                        <con2:path>"FAULT"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="layerName">
                                                        <con2:path>"ESB"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="flowID">
                                                        <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                                    </con2:param>
                                                    <con2:param name="inputElement">
                                                        <con2:path>$header/head:HeaderOut</con2:path>
                                                    </con2:param>
                                                </con2:xqueryTransform>
                                            </con1:expr>
                                        </con1:replace>
                                    </con4:outboundTransform>
                                </con4:route>
                                <con4:route xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con5="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config">
                                    <con1:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e71</con1:id>
                                    <con1:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con1:locked>
                                    <con4:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                    <con4:operation>execute</con4:operation>
                                    <con4:outboundTransform>
                                        <con3:routing-options>
                                            <con1:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e70</con1:id>
                                            <con1:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con1:locked>
                                            <con3:mode>request</con3:mode>
                                            <con3:qualityOfService>best-effort</con3:qualityOfService>
                                        </con3:routing-options>
                                        <con1:replace varName="body" contents-only="true" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config">
                                            <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e6f</con2:id>
                                            <con1:location>
                                                <con2:xpathText xmlns:con6="http://www.bea.com/wli/sb/stages/config">.</con2:xpathText>
                                            </con1:location>
                                            <con1:expr>
                                                <con2:xqueryTransform>
                                                    <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                                    <con2:param name="messageID">
                                                        <con2:path>$messageID</con2:path>
                                                    </con2:param>
                                                    <con2:param name="eventType">
                                                        <con2:path>"INBOUND:FAULT"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="serviceName">
                                                        <con2:path>fn:tokenize($mainInbound/@name, "\$")[last()]</con2:path>
                                                    </con2:param>
                                                    <con2:param name="inputSummary">
                                                        <con2:path>"SendPortNotification_FAULT_INBOUND"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="inputLevel">
                                                        <con2:path>1</con2:path>
                                                    </con2:param>
                                                    <con2:param name="execID">
                                                        <con2:path>$header/head:HeaderOut/head:execId/text()</con2:path>
                                                    </con2:param>
                                                    <con2:param name="eventCode">
                                                        <con2:path>data($exceptionDetails/detail/MessageFault/exceptionCode)</con2:path>
                                                    </con2:param>
                                                    <con2:param name="outboundServiceName">
                                                        <con2:path>fn:concat(fn:tokenize($outboundContext/@name, "\$")[last()-2],".",$outboundContext/ctx:service/ctx:operation/text())</con2:path>
                                                    </con2:param>
                                                    <con2:param name="processName">
                                                        <con2:path>fn:concat(fn:tokenize($mainInbound/@name, "\$")[last()],".",$incomingHeader/head:HeaderIn/head:operation/text())</con2:path>
                                                    </con2:param>
                                                    <con2:param name="eventStatus">
                                                        <con2:path>"FAULT"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="layerName">
                                                        <con2:path>"ESB"</con2:path>
                                                    </con2:param>
                                                    <con2:param name="flowID">
                                                        <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])
then $inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else $messageID</con2:path>
                                                    </con2:param>
                                                    <con2:param name="inputElement">
                                                        <con2:path>$fault</con2:path>
                                                    </con2:param>
                                                </con2:xqueryTransform>
                                            </con1:expr>
                                        </con1:replace>
                                    </con4:outboundTransform>
                                </con4:route>
                                <con5:javaCallout varName="errorMap" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                                    <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e6e</con2:id>
                                    <con1:archive ref="Utility/errormaphandling/errormaphandling"/>
                                    <con1:className>uk.co.o2.soa.sf.errormap.impl.FaultManagement</con1:className>
                                    <con1:method>public static java.lang.String retreiveDestErrorMessage(org.apache.xmlbeans.XmlObject, java.lang.String)</con1:method>
                                    <con1:expr>
                                        <con:xqueryText xmlns:con="http://www.bea.com/wli/sb/stages/config">$mainInbound</con:xqueryText>
                                    </con1:expr>
                                    <con1:expr>
                                        <con2:xqueryText>data($fault/ctx:details/con1:ErrorResponseDetail/con1:http-response-code)</con2:xqueryText>
                                    </con1:expr>
                                    <con1:return-param-as-ref>false</con1:return-param-as-ref>
                                </con5:javaCallout>
                            </con3:actions>
                        </con3:case>
                        <con3:default>
                            <con5:javaCallout varName="errorMap" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                                <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e6d</con2:id>
                                <con1:archive ref="Utility/errormaphandling/errormaphandling"/>
                                <con1:className>uk.co.o2.soa.sf.errormap.impl.FaultManagement</con1:className>
                                <con1:method>public static java.lang.String retreiveDestErrorMessage(org.apache.xmlbeans.XmlObject, java.lang.String)</con1:method>
                                <con1:expr>
                                    <con:xqueryText xmlns:con="http://www.bea.com/wli/sb/stages/config">$mainInbound</con:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>data($fault/ctx:errorCode)</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con5:javaCallout>
                        </con3:default>
                    </con3:ifThenElse>
                    <con2:assign varName="errorMapXML" xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config">
                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e6c</con5:id>
                        <con2:expr>
                            <con:xqueryText xmlns:con="http://www.bea.com/wli/sb/stages/config">fn-bea:inlinedXML($errorMap)</con:xqueryText>
                        </con2:expr>
                    </con2:assign>
                    <con5:assign varName="faultXML" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                        <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e6b</con6:id>
                        <con2:expr>
                            <con6:xqueryTransform xmlns:con6="http://www.bea.com/wli/sb/stages/config">
                                <con6:resource ref="sampleSB/transformations/faultResponse"/>
                                <con6:param name="faultReason">
                                    <con6:path>fn-bea:serialize(data($fault/ctx:reason))</con6:path>
                                </con6:param>
                                <con6:param name="errorMapXML">
                                    <con6:path>$errorMapXML</con6:path>
                                </con6:param>
                                <con6:param name="faultCode">
                                    <con6:path>fn-bea:serialize(data($fault/ctx:errorCode))</con6:path>
                                </con6:param>
                                <con6:param name="NCxmlErrResp">
                                    <con6:path>$NCxmlErrResp</con6:path>
                                </con6:param>
                            </con6:xqueryTransform>
                        </con2:expr>
                    </con5:assign>
                    <con2:nxsdTranslation xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config">
                        <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e6a</con6:id>
                        <con5:type>XML-To-Native</con5:type>
                        <con5:sourceExpr>
                            <con1:xqueryText xmlns:con6="http://www.bea.com/wli/sb/stages/config">$faultXML</con1:xqueryText>
                        </con5:sourceExpr>
                        <con2:nxsd ref="sampleSB/schemas/nxsd_schema_faultResponse"/>
                        <con2:schemaElement xmlns:ser="http://TargetNamespace.com/ServiceName">ser:faultResponse</con2:schemaElement>
                        <con5:assign-variable>finalFaultResponse</con5:assign-variable>
                        <con5:enforceSchemaOrder>false</con5:enforceSchemaOrder>
                    </con2:nxsdTranslation>
                    <con5:replace contents-only="true" varName="body" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                        <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e69</con6:id>
                        <con2:location>
                            <con1:xpathText xmlns:con6="http://www.bea.com/wli/sb/stages/config">.</con1:xpathText>
                        </con2:location>
                        <con2:expr>
                            <con1:xqueryText xmlns:con6="http://www.bea.com/wli/sb/stages/config">fn-bea:binary-to-text($finalFaultResponse,'UTF-8')</con1:xqueryText>
                        </con2:expr>
                    </con5:replace>
                    <con4:replace varName="header" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config">
                        <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e68</con2:id>
                        <con1:location>
                            <con2:xpathText>.</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xqueryTransform>
                                <con2:resource ref="CommonResources/transformations/ConstructResponseSOAPHeaderForCookie"/>
                                <con2:param name="inbound_header">
                                    <con2:path>false()</con2:path>
                                </con2:param>
                                <con2:param name="onError">
                                    <con2:path>true()</con2:path>
                                </con2:param>
                                <con2:param name="jsessionValue">
                                    <con2:path>$jsessionValue</con2:path>
                                </con2:param>
                                <con2:param name="inbound">
                                    <con2:path>$inbound</con2:path>
                                </con2:param>
                                <con2:param name="header">
                                    <con2:path>$incomingHeader</con2:path>
                                </con2:param>
                                <con2:param name="aviValue">
                                    <con2:path>$aviValue</con2:path>
                                </con2:param>
                            </con2:xqueryTransform>
                        </con1:expr>
                    </con4:replace>
                    <con5:replace varName="inbound" contents-only="false" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
                        <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e67</con2:id>
                        <con1:location>
                            <con2:xpathText>./ctx:transport/ctx:response</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xqueryTransform>
                                <con2:resource ref="CommonResources/transformations/ConstructResponseUserHeader"/>
                                <con2:param name="incomingHeader">
                                    <con2:path>$incomingHeader</con2:path>
                                </con2:param>
                                <con2:param name="header">
                                    <con2:path>$header</con2:path>
                                </con2:param>
                            </con2:xqueryTransform>
                        </con1:expr>
                    </con5:replace>
                    <con2:insert varName="inbound" xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config">
                        <con1:comment xmlns:con6="http://www.bea.com/wli/sb/stages/config">Destination http status code.</con1:comment>
                        <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e66</con6:id>
                        <con2:location>
                            <con1:xpathText xmlns:con6="http://www.bea.com/wli/sb/stages/config">./ctx:transport/ctx:response</con1:xpathText>
                        </con2:location>
                        <con2:where>first-child</con2:where>
                        <con2:expr>
                            <con1:xqueryText xmlns:con6="http://www.bea.com/wli/sb/stages/config">if(data($configXML/mappings/mapping[errorCode=data($errorMapXML/code)]/responseCode)) then
&lt;http:http-response-code>{ data($configXML/mappings/mapping[errorCode=data($errorMapXML/code)]/responseCode) }&lt;/http:http-response-code>
else ()</con1:xqueryText>
                        </con2:expr>
                    </con2:insert>
                    <con3:transport-headers copy-all="false" xmlns:con1="http://www.bea.com/wli/sb/stages/routing/config" xmlns:ser="http://www.bea.com/wli/sb/services" xmlns:http="http://www.bea.com/wli/sb/transports/http" xmlns:oper="http://xmlns.oracle.com/servicebus/pipeline/operations" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:env="http://www.bea.com/wli/config/env" xmlns:con5="http://www.bea.com/wli/sb/stages/publish/config" xmlns:tran="http://www.bea.com/wli/sb/transports">
                        <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e65</con2:id>
                        <con3:header-set>inbound-response</con3:header-set>
                        <con3:header name="Content-Type" value="expression">
                            <con2:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">'application/json'</con2:xqueryText>
                        </con3:header>
                    </con3:transport-headers>
                    <con2:assign varName="exceptionDetails" xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config">
                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e64</con5:id>
                        <con4:expr>
                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<Fault>
<detail>
<MessageFault>
<exceptionCode>{data(fn-bea:inlinedXML($errorMap)/code)}</exceptionCode>
<exceptionDetail>{data(fn-bea:inlinedXML($errorMap)/description)}</exceptionDetail>
</MessageFault>
</detail>
</Fault>]]></con5:xqueryText>
                        </con4:expr>
                    </con2:assign>
                    <con6:route xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con5="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con6="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config">
                        <con1:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e63</con1:id>
                        <con1:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con1:locked>
                        <con4:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con6:operation>execute</con6:operation>
                        <con4:outboundTransform>
                            <con3:routing-options>
                                <con1:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e62</con1:id>
                                <con1:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con1:locked>
                                <con3:mode>request</con3:mode>
                                <con3:qualityOfService>best-effort</con3:qualityOfService>
                            </con3:routing-options>
                            <con5:replace varName="body" contents-only="true" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
                                <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e61</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                        <con2:param name="messageID">
                                            <con2:path>$messageID</con2:path>
                                        </con2:param>
                                        <con2:param name="eventType">
                                            <con2:path>if(data($IsOrchestratedCall)="true") then
"EXIT:HEADER"
else
"END:HEADER"</con2:path>
                                        </con2:param>
                                        <con2:param name="serviceName">
                                            <con2:path>fn:tokenize($mainInbound/@name, "\$")[last()]</con2:path>
                                        </con2:param>
                                        <con2:param name="inputSummary">
                                            <con2:path>"SendPortNotification_HEADER_Response"</con2:path>
                                        </con2:param>
                                        <con2:param name="inputLevel">
                                            <con2:path>1</con2:path>
                                        </con2:param>
                                        <con2:param name="execID">
                                            <con2:path>$header/head:HeaderOut/head:execId/text()</con2:path>
                                        </con2:param>
                                        <con2:param name="eventCode">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="outboundServiceName">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="processName">
                                            <con2:path>fn:concat(fn:tokenize($mainInbound/@name, "\$")[last()],".",$incomingHeader/head:HeaderIn/head:operation/text())</con2:path>
                                        </con2:param>
                                        <con2:param name="eventStatus">
                                            <con2:path>"FAULT"</con2:path>
                                        </con2:param>
                                        <con2:param name="layerName">
                                            <con2:path>"ESB"</con2:path>
                                        </con2:param>
                                        <con2:param name="flowID">
                                            <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])then 
$inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else 
$messageID</con2:path>
                                        </con2:param>
                                        <con2:param name="inputElement">
                                            <con2:path>$header/head:HeaderOut</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con5:replace>
                        </con4:outboundTransform>
                    </con6:route>
                    <con6:route xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con5="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con6="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config">
                        <con1:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e60</con1:id>
                        <con1:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con1:locked>
                        <con4:service ref="ArchitectureServices/ApplicationTraceService/ProxyServices/ApplicationTraceServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con6:operation>execute</con6:operation>
                        <con4:outboundTransform>
                            <con3:routing-options>
                                <con1:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e5f</con1:id>
                                <con1:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con1:locked>
                                <con3:mode>request</con3:mode>
                                <con3:qualityOfService>best-effort</con3:qualityOfService>
                            </con3:routing-options>
                            <con5:replace varName="body" contents-only="true" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
                                <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e5e</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="CommonResources/transformations/toCommonLogger"/>
                                        <con2:param name="messageID">
                                            <con2:path>$messageID</con2:path>
                                        </con2:param>
                                        <con2:param name="eventType">
                                            <con2:path>if(data($IsOrchestratedCall)="true") then
"EXIT:FAULT"
else
"END:FAULT"</con2:path>
                                        </con2:param>
                                        <con2:param name="serviceName">
                                            <con2:path>fn:tokenize($mainInbound/@name, "\$")[last()]</con2:path>
                                        </con2:param>
                                        <con2:param name="inputSummary">
                                            <con2:path>"SendPortNotification_Fault"</con2:path>
                                        </con2:param>
                                        <con2:param name="inputLevel">
                                            <con2:path>1</con2:path>
                                        </con2:param>
                                        <con2:param name="execID">
                                            <con2:path>$header/head:HeaderOut/head:execId/text()</con2:path>
                                        </con2:param>
                                        <con2:param name="eventCode">
                                            <con2:path>data($exceptionDetails/detail/MessageFault/exceptionCode)</con2:path>
                                        </con2:param>
                                        <con2:param name="outboundServiceName">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="processName">
                                            <con2:path>fn:concat(fn:tokenize($mainInbound/@name, "\$")[last()],".",$incomingHeader/head:HeaderIn/head:operation/text())</con2:path>
                                        </con2:param>
                                        <con2:param name="eventStatus">
                                            <con2:path>"FAULT"</con2:path>
                                        </con2:param>
                                        <con2:param name="layerName">
                                            <con2:path>"ESB"</con2:path>
                                        </con2:param>
                                        <con2:param name="flowID">
                                            <con2:path>if($inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"])then 
$inbound/ctx:transport/ctx:request/tp:headers/tp:user-header[@name="customFlowID"]/@value
else 
$messageID</con2:path>
                                        </con2:param>
                                        <con2:param name="inputElement">
                                            <con2:path>&lt;soapenv:Body xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">{data($body)}&lt;/soapenv:Body></con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con5:replace>
                        </con4:outboundTransform>
                    </con6:route>
                    <con7:route xmlns:con1="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con5="http://www.bea.com/wli/sb/typesystem/config" xmlns:con7="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config">
                        <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e5d</con2:id>
                        <con6:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con6:locked>
                        <con1:service ref="ArchitectureServices/ExecutionLogService/ProxyServices/ExecutionLogServiceLocal_v1" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con7:operation>execute</con7:operation>
                        <con1:outboundTransform>
                            <con3:routing-options>
                                <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e5c</con2:id>
                                <con6:locked xmlns:con6="http://www.bea.com/wli/sb/stages/config">true</con6:locked>
                                <con3:mode>request</con3:mode>
                                <con3:qualityOfService>best-effort</con3:qualityOfService>
                            </con3:routing-options>
                            <con3:replace varName="body" contents-only="true" xmlns:con1="http://www.bea.com/wli/sb/stages/routing/config">
                                <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e5b</con2:id>
                                <con3:location>
                                    <con2:xpathText xmlns:con5="http://www.bea.com/wli/sb/stages/config">.</con2:xpathText>
                                </con3:location>
                                <con3:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="CommonResources/transformations/ExecutionLogInfo"/>
                                        <con2:param name="tExecBackend">
                                            <con2:path>""</con2:path>
                                        </con2:param>
                                        <con2:param name="incomingHeader">
                                            <con2:path>$incomingHeader</con2:path>
                                        </con2:param>
                                        <con2:param name="resultCode">
                                            <con2:path>"KO"</con2:path>
                                        </con2:param>
                                        <con2:param name="messageID">
                                            <con2:path>$messageID</con2:path>
                                        </con2:param>
                                        <con2:param name="error">
                                            <con2:path>$exceptionDetails</con2:path>
                                        </con2:param>
                                        <con2:param name="layer">
                                            <con2:path>"ESB"</con2:path>
                                        </con2:param>
                                        <con2:param name="errorText">
                                            <con2:path>fn-bea:serialize($exceptionDetails)</con2:path>
                                        </con2:param>
                                        <con2:param name="serviceBackend">
                                            <con2:path>fn:tokenize($outboundContext/@name, "\$")[last()]</con2:path>
                                        </con2:param>
                                        <con2:param name="operationBackend">
                                            <con2:path>$outboundContext/ctx:service/ctx:operation/text()</con2:path>
                                        </con2:param>
                                        <con2:param name="service">
                                            <con2:path>fn:tokenize($mainInbound/@name, "\$")[last()]</con2:path>
                                        </con2:param>
                                        <con2:param name="outboundContext">
                                            <con2:path>&lt;outboundContext/></con2:path>
                                        </con2:param>
                                        <con2:param name="header">
                                            <con2:path>$header</con2:path>
                                        </con2:param>
                                        <con2:param name="inboundContext">
                                            <con2:path>$inboundContext</con2:path>
                                        </con2:param>
                                        <con2:param name="execStartTime">
                                            <con2:path>$execStartTime</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con3:expr>
                            </con3:replace>
                        </con1:outboundTransform>
                    </con7:route>
                    <con2:reply isError="true" xmlns:con1="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con6="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con7="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con5="http://www.bea.com/wli/sb/typesystem/config">
                        <con2:id>_ActionId-N53ede7ac.N193d93f5.0.18ba383078a.N7e5a</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:flow>
            <con:pipeline-node name="common logging gateway">
                <con:request>request-N53edf6a2.N3b0158.0.18b36bcce0e.N7ff1</con:request>
                <con:response>response-N53edf6a2.N3b0158.0.18b36bcce0e.N7ff0</con:response>
            </con:pipeline-node>
            <con:pipeline-node name="request-response">
                <con:request>request-N53edf6a2.N3b0158.0.18b36bcce0e.N7f48</con:request>
                <con:response>response-N53edf6a2.N3b0158.0.18b36bcce0e.N7f47</con:response>
            </con:pipeline-node>
        </con:flow>
    </con:router>
</con:pipelineEntry>